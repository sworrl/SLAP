<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLAP - Scoreboard Live Automation Platform</title>
    <link rel="icon" type="image/png" href="/static/img/favicon.png">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header-logo {
            width: 80px;
            height: 80px;
            margin-bottom: 10px;
            filter: drop-shadow(0 0 10px rgba(0, 212, 255, 0.5));
        }

        .header h1 {
            font-size: 2.5rem;
            color: #00d4ff;
            margin-bottom: 5px;
        }

        .header .subtitle {
            color: #888;
            font-size: 0.9rem;
        }

        /* Mode Toggle */
        .mode-toggle {
            display: flex;
            justify-content: center;
            gap: 0;
            margin-top: 15px;
        }

        .mode-btn {
            padding: 10px 30px;
            border: 2px solid #00d4ff;
            background: transparent;
            color: #00d4ff;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-btn:first-child {
            border-radius: 8px 0 0 8px;
        }

        .mode-btn:last-child {
            border-radius: 0 8px 8px 0;
            border-left: none;
        }

        .mode-btn.active {
            background: #00d4ff;
            color: #000;
        }

        .mode-btn.preview.active {
            background: #00d4ff;
            border-color: #00d4ff;
        }

        .mode-btn.live.active {
            background: #ff4444;
            border-color: #ff4444;
            color: #fff;
        }

        .mode-btn.live {
            border-color: #ff4444;
            color: #ff4444;
        }

        .mode-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .mode-indicator.preview {
            background: #00d4ff;
            color: #000;
        }

        .mode-indicator.live {
            background: #ff4444;
            color: #fff;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 1000px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: #16213e;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #0f3460;
        }

        .card h2 {
            color: #00d4ff;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2::before {
            content: '';
            width: 4px;
            height: 20px;
            background: #00d4ff;
            border-radius: 2px;
        }

        /* Scorebug Preview */
        .preview-container {
            grid-column: 1 / -1;
        }

        .preview-frame {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .preview-frame iframe {
            width: 100%;
            height: 100%;
            border: none;
            transform-origin: top left;
        }

        /* Score Display */
        .score-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            padding: 20px;
        }

        .team {
            text-align: center;
        }

        .team-name {
            font-size: 1.2rem;
            color: #888;
            margin-bottom: 10px;
        }

        .team-score {
            font-size: 4rem;
            font-weight: bold;
        }

        .team-score.home { color: #4a9eff; }
        .team-score.away { color: #ff4a4a; }

        .vs {
            font-size: 1.5rem;
            color: #444;
        }

        /* Game Info */
        .game-info {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 15px;
        }

        .info-item {
            text-align: center;
        }

        .info-label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #fff;
        }

        /* Controls */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: #00d4ff;
            color: #000;
        }

        .btn-primary:hover {
            background: #00b8e6;
        }

        .btn-success {
            background: #00c853;
            color: #000;
        }

        .btn-danger {
            background: #ff1744;
            color: #fff;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .btn-secondary {
            background: #444;
            color: #fff;
        }

        .btn-home {
            background: #4a9eff;
            color: #000;
        }

        .btn-away {
            background: #ff4a4a;
            color: #fff;
        }

        .btn-group {
            display: flex;
            gap: 5px;
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 0.8rem;
        }

        /* Status indicators */
        .status-bar {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff1744;
        }

        .status-dot.connected {
            background: #00c853;
        }

        .status-label {
            font-size: 0.9rem;
            color: #888;
        }

        /* Penalties */
        .penalties {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .penalty-box {
            background: #0f3460;
            padding: 15px 20px;
            border-radius: 8px;
            min-width: 150px;
        }

        .penalty-box h3 {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 10px;
        }

        .penalty-list {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .penalty-list.home { color: #4a9eff; }
        .penalty-list.away { color: #ff4a4a; }

        /* Manual Input */
        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .input-group label {
            min-width: 80px;
            color: #888;
        }

        .input-group input {
            background: #0f3460;
            border: 1px solid #1a4a7a;
            border-radius: 6px;
            padding: 8px 12px;
            color: #fff;
            font-size: 1rem;
            width: 100px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #00d4ff;
        }
    </style>
</head>
<body>
    <div class="header">
        <img src="/static/img/SLAP_icon.webp" alt="SLAP" class="header-logo">
        <h1>SLAP <span class="mode-indicator preview" id="modeIndicator">PREVIEW</span></h1>
        <p class="subtitle">Scoreboard Live Automation Platform</p>
        <div class="mode-toggle">
            <button class="mode-btn preview active" id="btnPreview" onclick="setMode('preview')">Preview</button>
            <button class="mode-btn live" id="btnLive" onclick="setMode('live')">Live</button>
        </div>
    </div>

    <div class="container">
        <!-- Scorebug Preview -->
        <div class="card preview-container">
            <h2 id="previewTitle">Preview</h2>
            <div class="preview-frame">
                <iframe id="scorebugPreview" src="/scorebug"></iframe>
            </div>
        </div>

        <!-- Score Display -->
        <div class="card">
            <h2>Current Score</h2>
            <div class="score-display">
                <div class="team">
                    <div class="team-name" id="homeTeamName">HOME</div>
                    <div class="team-score home" id="homeScore">0</div>
                </div>
                <div class="vs">vs</div>
                <div class="team">
                    <div class="team-name" id="awayTeamName">AWAY</div>
                    <div class="team-score away" id="awayScore">0</div>
                </div>
            </div>
            <div class="game-info">
                <div class="info-item">
                    <div class="info-label">Period</div>
                    <div class="info-value" id="period">1st</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Clock</div>
                    <div class="info-value" id="clock">20:00</div>
                </div>
            </div>
        </div>

        <!-- Simulator Controls -->
        <div class="card">
            <h2>Simulator</h2>
            <div class="controls">
                <button class="btn btn-success" onclick="startSimulator()">Start</button>
                <button class="btn btn-danger" onclick="stopSimulator()">Stop</button>
                <button class="btn btn-warning" onclick="resetSimulator()">Reset</button>
            </div>
            <div class="status-bar" style="margin-top: 15px;">
                <div class="status-item">
                    <div class="status-dot" id="simStatus"></div>
                    <span class="status-label">Simulator</span>
                </div>
            </div>
        </div>

        <!-- Goal Controls -->
        <div class="card">
            <h2>Goals</h2>
            <div class="controls">
                <button class="btn btn-home" onclick="triggerGoal('HOME')">Home Goal</button>
                <button class="btn btn-away" onclick="triggerGoal('AWAY')">Away Goal</button>
            </div>
        </div>

        <!-- Score Adjustments -->
        <div class="card">
            <h2>Manual Score</h2>
            <div class="controls">
                <div class="btn-group">
                    <button class="btn btn-sm btn-home" onclick="adjustScore('home', -1)">-</button>
                    <span style="padding: 8px; color: #4a9eff;">Home</span>
                    <button class="btn btn-sm btn-home" onclick="adjustScore('home', 1)">+</button>
                </div>
                <div class="btn-group">
                    <button class="btn btn-sm btn-away" onclick="adjustScore('away', -1)">-</button>
                    <span style="padding: 8px; color: #ff4a4a;">Away</span>
                    <button class="btn btn-sm btn-away" onclick="adjustScore('away', 1)">+</button>
                </div>
            </div>
        </div>

        <!-- Period/Clock Controls -->
        <div class="card">
            <h2>Clock Controls</h2>
            <div class="input-group">
                <label>Period:</label>
                <select id="periodSelect" onchange="updatePeriod()" style="background: #0f3460; border: 1px solid #1a4a7a; border-radius: 6px; padding: 8px 12px; color: #fff;">
                    <option value="1">1st</option>
                    <option value="2">2nd</option>
                    <option value="3">3rd</option>
                    <option value="OT">OT</option>
                </select>
            </div>
            <div class="input-group">
                <label>Clock:</label>
                <input type="text" id="clockInput" value="20:00" placeholder="MM:SS">
                <button class="btn btn-sm btn-primary" onclick="updateClock()">Set</button>
            </div>
        </div>

        <!-- Penalties -->
        <div class="card">
            <h2>Penalties</h2>
            <div class="penalties">
                <div class="penalty-box">
                    <h3>Home</h3>
                    <div class="penalty-list home" id="homePenalties">None</div>
                </div>
                <div class="penalty-box">
                    <h3>Away</h3>
                    <div class="penalty-list away" id="awayPenalties">None</div>
                </div>
            </div>
            <div class="controls" style="margin-top: 15px; justify-content: center;">
                <button class="btn btn-sm btn-home" onclick="addPenalty('HOME', 120)">Home 2min</button>
                <button class="btn btn-sm btn-home" onclick="addPenalty('HOME', 300)">Home 5min</button>
                <button class="btn btn-sm btn-away" onclick="addPenalty('AWAY', 120)">Away 2min</button>
                <button class="btn btn-sm btn-away" onclick="addPenalty('AWAY', 300)">Away 5min</button>
            </div>
        </div>

        <!-- Bug Visibility -->
        <div class="card">
            <h2>Scorebug Display</h2>
            <div class="controls">
                <button class="btn btn-success" onclick="showBug()">Show</button>
                <button class="btn btn-danger" onclick="hideBug()">Hide</button>
            </div>
            <div class="status-bar" style="margin-top: 15px;">
                <div class="status-item">
                    <div class="status-dot" id="bugStatus"></div>
                    <span class="status-label">Visible</span>
                </div>
            </div>
        </div>

        <!-- Connection Status -->
        <div class="card">
            <h2>Connection Status</h2>
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-dot" id="serialStatus"></div>
                    <span class="status-label">Serial</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="casparStatus"></div>
                    <span class="status-label">CasparCG</span>
                </div>
                <div class="status-item">
                    <div class="status-dot connected" id="wsStatus"></div>
                    <span class="status-label">WebSocket</span>
                </div>
            </div>
        </div>

        <!-- CasparCG Server Control -->
        <div class="card">
            <h2>CasparCG Server</h2>
            <div class="status-bar" style="margin-bottom: 15px;">
                <div class="status-item">
                    <div class="status-dot" id="casparInstalled"></div>
                    <span class="status-label">Installed</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="casparRunning"></div>
                    <span class="status-label">Running</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="casparAmcp"></div>
                    <span class="status-label">AMCP</span>
                </div>
            </div>
            <div class="controls">
                <button class="btn btn-success" onclick="casparStart()" id="btnCasparStart">Start Server</button>
                <button class="btn btn-danger" onclick="casparStop()" id="btnCasparStop">Stop Server</button>
                <button class="btn btn-primary" onclick="casparConnect()" id="btnCasparConnect">Connect</button>
                <button class="btn btn-secondary" onclick="casparRefresh()">Refresh</button>
            </div>
            <div id="casparInfo" style="margin-top: 10px; font-size: 0.85rem; color: #888;"></div>
        </div>

        <!-- OBS Studio Control -->
        <div class="card">
            <h2>OBS Studio</h2>
            <div class="status-bar" style="margin-bottom: 15px;">
                <div class="status-item">
                    <div class="status-dot" id="obsInstalled"></div>
                    <span class="status-label">Installed</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="obsRunning"></div>
                    <span class="status-label">Running</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="obsWebsocket"></div>
                    <span class="status-label">WebSocket</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="obsConnected"></div>
                    <span class="status-label">Connected</span>
                </div>
            </div>
            <div class="controls">
                <button class="btn btn-success" onclick="obsStart()" id="btnObsStart">Start OBS</button>
                <button class="btn btn-danger" onclick="obsStop()" id="btnObsStop">Stop OBS</button>
                <button class="btn btn-primary" onclick="obsConnect()" id="btnObsConnect">Connect</button>
                <button class="btn btn-secondary" onclick="obsRefresh()">Refresh</button>
            </div>
            <div id="obsInfo" style="margin-top: 10px; font-size: 0.85rem; color: #888;"></div>
        </div>

        <!-- OBS Scorebug Setup -->
        <div class="card" id="obsScorebuCard" style="display: none;">
            <h2>OBS Scorebug Overlay</h2>
            <p style="color: #888; font-size: 0.9rem; margin-bottom: 15px;">
                Add the SLAP scorebug as a browser source in your current OBS scene.
            </p>
            <div class="controls">
                <button class="btn btn-primary" onclick="obsSetupScoreBug()">Add Scorebug to Scene</button>
                <button class="btn btn-success" onclick="obsShowScoreBug()">Show</button>
                <button class="btn btn-danger" onclick="obsHideScoreBug()">Hide</button>
                <button class="btn btn-secondary" onclick="obsRefreshScoreBug()">Refresh</button>
            </div>
            <div id="obsSceneInfo" style="margin-top: 10px; font-size: 0.85rem; color: #888;"></div>
        </div>

        <!-- Serial Port Configuration -->
        <div class="card">
            <h2>Serial Port (MP-70)</h2>
            <div class="status-bar" style="margin-bottom: 15px;">
                <div class="status-item">
                    <div class="status-dot" id="serialConnected"></div>
                    <span class="status-label">Connected</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="serialSimMode"></div>
                    <span class="status-label">Sim Mode</span>
                </div>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #888;">Serial Port:</label>
                <select id="serialPortSelect" style="width: 100%; padding: 8px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px;">
                    <option value="">-- Select Port --</option>
                </select>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; color: #888;">Baud Rate:</label>
                <select id="serialBaudSelect" style="width: 100%; padding: 8px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px;">
                    <option value="9600" selected>9600</option>
                    <option value="19200">19200</option>
                    <option value="38400">38400</option>
                    <option value="57600">57600</option>
                    <option value="115200">115200</option>
                </select>
            </div>
            <div class="controls">
                <button class="btn btn-primary" onclick="serialApplyConfig()">Apply & Restart</button>
                <button class="btn btn-secondary" onclick="serialRefreshPorts()">Refresh Ports</button>
                <button class="btn btn-warning" onclick="toggleSimMode()">Toggle Sim Mode</button>
            </div>
            <div id="serialInfo" style="margin-top: 10px; font-size: 0.85rem; color: #888;"></div>
        </div>

        <!-- Serial Debug Log -->
        <div class="card">
            <h2>Serial Debug</h2>
            <p style="color: #888; font-size: 0.9rem; margin-bottom: 10px;">
                Run with <code>--debug</code> flag to see raw serial data in logs.
            </p>
            <div class="controls">
                <button class="btn btn-secondary" onclick="viewLogs()">View Logs</button>
            </div>
            <pre id="serialLog" style="background: #1a1a1a; padding: 10px; border-radius: 4px; max-height: 200px; overflow-y: auto; font-size: 0.8rem; color: #0f0; margin-top: 10px; display: none;"></pre>
        </div>

        <!-- Broadcast Overlays Control -->
        <div class="card" style="grid-column: 1 / -1;">
            <h2>Broadcast Overlays</h2>
            <p style="color: #888; font-size: 0.9rem; margin-bottom: 15px;">
                Trigger NHL-style broadcast graphics. Each overlay has a unique URL for CasparCG or OBS browser sources.
            </p>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px;">
                <!-- Goal Splash -->
                <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; border-left: 4px solid #ffd700;">
                    <h3 style="color: #ffd700; margin-bottom: 10px; font-size: 1rem;">Goal Splash</h3>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px;">
                        <button class="btn btn-sm btn-home" onclick="triggerGoalSplash('home')">Home Goal</button>
                        <button class="btn btn-sm btn-away" onclick="triggerGoalSplash('away')">Away Goal</button>
                        <button class="btn btn-sm btn-secondary" onclick="hideOverlay('goal')">Hide</button>
                    </div>
                    <code style="font-size: 0.75rem; color: #666;">/overlay/goal</code>
                </div>

                <!-- Replay Bug -->
                <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; border-left: 4px solid #ff4444;">
                    <h3 style="color: #ff4444; margin-bottom: 10px; font-size: 1rem;">Replay Bug</h3>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px;">
                        <button class="btn btn-sm btn-danger" onclick="showReplay()">REPLAY</button>
                        <button class="btn btn-sm btn-secondary" onclick="hideOverlay('replay')">Hide</button>
                    </div>
                    <code style="font-size: 0.75rem; color: #666;">/overlay/replay</code>
                </div>

                <!-- Player Card -->
                <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; border-left: 4px solid #00d4ff;">
                    <h3 style="color: #00d4ff; margin-bottom: 10px; font-size: 1rem;">Player Card</h3>
                    <div style="margin-bottom: 10px;">
                        <input type="text" id="playerNum" placeholder="#" style="width: 50px; padding: 5px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px;" maxlength="3">
                        <input type="text" id="playerName" placeholder="Name" style="width: 120px; padding: 5px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px;">
                    </div>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px;">
                        <button class="btn btn-sm btn-home" onclick="showPlayerCard('home')">Show (Home)</button>
                        <button class="btn btn-sm btn-away" onclick="showPlayerCard('away')">Show (Away)</button>
                        <button class="btn btn-sm btn-secondary" onclick="hideOverlay('player')">Hide</button>
                    </div>
                    <code style="font-size: 0.75rem; color: #666;">/overlay/player</code>
                </div>

                <!-- Goalie Stats -->
                <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; border-left: 4px solid #00c853;">
                    <h3 style="color: #00c853; margin-bottom: 10px; font-size: 1rem;">Goalie Stats</h3>
                    <div style="margin-bottom: 10px;">
                        <input type="text" id="goalieNum" placeholder="#" style="width: 50px; padding: 5px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px;" maxlength="3">
                        <input type="number" id="goalieSaves" placeholder="Saves" style="width: 70px; padding: 5px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px;">
                        <input type="number" id="goalieShots" placeholder="Shots" style="width: 70px; padding: 5px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px;">
                    </div>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px;">
                        <button class="btn btn-sm btn-success" onclick="showGoalieStats()">Show</button>
                        <button class="btn btn-sm btn-secondary" onclick="hideOverlay('goalie')">Hide</button>
                    </div>
                    <code style="font-size: 0.75rem; color: #666;">/overlay/goalie</code>
                </div>

                <!-- Period Summary -->
                <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; border-left: 4px solid #9c27b0;">
                    <h3 style="color: #9c27b0; margin-bottom: 10px; font-size: 1rem;">Period Summary</h3>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px;">
                        <button class="btn btn-sm btn-primary" onclick="showPeriodSummary()">Show</button>
                        <button class="btn btn-sm btn-secondary" onclick="hideOverlay('period')">Hide</button>
                    </div>
                    <code style="font-size: 0.75rem; color: #666;">/overlay/period</code>
                </div>

                <!-- Game Intro -->
                <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; border-left: 4px solid #ff9800;">
                    <h3 style="color: #ff9800; margin-bottom: 10px; font-size: 1rem;">Game Intro</h3>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px;">
                        <button class="btn btn-sm btn-warning" onclick="showGameIntro()">Show Matchup</button>
                        <button class="btn btn-sm btn-secondary" onclick="hideOverlay('intro')">Hide</button>
                    </div>
                    <code style="font-size: 0.75rem; color: #666;">/overlay/intro</code>
                </div>

                <!-- Three Stars -->
                <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; border-left: 4px solid #c0c0c0;">
                    <h3 style="color: #c0c0c0; margin-bottom: 10px; font-size: 1rem;">Three Stars</h3>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px;">
                        <button class="btn btn-sm" style="background: linear-gradient(135deg, #ffd700, #daa520); color: #000;" onclick="showThreeStars()">Show Stars</button>
                        <button class="btn btn-sm btn-secondary" onclick="hideOverlay('stars')">Hide</button>
                    </div>
                    <code style="font-size: 0.75rem; color: #666;">/overlay/stars</code>
                </div>

                <!-- Power Play -->
                <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; border-left: 4px solid #ffeb3b;">
                    <h3 style="color: #ffeb3b; margin-bottom: 10px; font-size: 1rem;">Power Play Graphic</h3>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px;">
                        <button class="btn btn-sm btn-home" onclick="showPowerPlay('home')">Home PP</button>
                        <button class="btn btn-sm btn-away" onclick="showPowerPlay('away')">Away PP</button>
                        <button class="btn btn-sm btn-secondary" onclick="hideOverlay('powerplay')">Hide</button>
                    </div>
                    <code style="font-size: 0.75rem; color: #666;">/overlay/powerplay</code>
                </div>

                <!-- Shot Counter -->
                <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; border-left: 4px solid #4caf50;">
                    <h3 style="color: #4caf50; margin-bottom: 10px; font-size: 1rem;">Shot Counter</h3>
                    <div style="margin-bottom: 10px;">
                        <input type="number" id="homeShots" placeholder="Home" style="width: 70px; padding: 5px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px;" value="0">
                        <input type="number" id="awayShots" placeholder="Away" style="width: 70px; padding: 5px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px;" value="0">
                    </div>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px;">
                        <button class="btn btn-sm btn-success" onclick="updateShotCounter()">Update</button>
                    </div>
                    <code style="font-size: 0.75rem; color: #666;">/overlay/shots</code>
                </div>

                <!-- Penalty Box -->
                <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; border-left: 4px solid #f44336;">
                    <h3 style="color: #f44336; margin-bottom: 10px; font-size: 1rem;">Penalty Details</h3>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px;">
                        <button class="btn btn-sm btn-home" onclick="addPenaltyOverlay('home')">Home Penalty</button>
                        <button class="btn btn-sm btn-away" onclick="addPenaltyOverlay('away')">Away Penalty</button>
                    </div>
                    <code style="font-size: 0.75rem; color: #666;">/overlay/penalty</code>
                </div>

                <!-- Ticker -->
                <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                    <h3 style="color: #2196f3; margin-bottom: 10px; font-size: 1rem;">Scores Ticker</h3>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px;">
                        <button class="btn btn-sm btn-primary" onclick="showTicker()">Show Demo</button>
                        <button class="btn btn-sm btn-secondary" onclick="hideOverlay('ticker')">Hide</button>
                    </div>
                    <code style="font-size: 0.75rem; color: #666;">/overlay/ticker</code>
                </div>
            </div>

            <div style="margin-top: 20px; padding: 15px; background: #0f3460; border-radius: 8px;">
                <h4 style="color: #00d4ff; margin-bottom: 10px;">Overlay URLs</h4>
                <p style="color: #888; font-size: 0.85rem;">
                    Use these URLs in CasparCG HTML templates or OBS Browser Sources:
                </p>
                <ul style="color: #666; font-size: 0.8rem; list-style: none; padding: 0; margin-top: 10px;">
                    <li><code>/overlay</code> - Main scorebug</li>
                    <li><code>/overlay/goal</code> - Goal celebration</li>
                    <li><code>/overlay/player</code> - Player card (lower third)</li>
                    <li><code>/overlay/goalie</code> - Goalie statistics</li>
                    <li><code>/overlay/period</code> - Period summary</li>
                    <li><code>/overlay/intro</code> - Game intro/matchup</li>
                    <li><code>/overlay/stars</code> - Three stars</li>
                    <li><code>/overlay/powerplay</code> - Power play graphic</li>
                    <li><code>/overlay/shots</code> - Shot counter</li>
                    <li><code>/overlay/penalty</code> - Penalty box details</li>
                    <li><code>/overlay/replay</code> - Replay bug</li>
                    <li><code>/overlay/ticker</code> - Scores ticker/crawl</li>
                </ul>
            </div>
        </div>

        <!-- Team Customization -->
        <div class="card">
            <h2>Team Customization</h2>
            <p style="color: #888; font-size: 0.9rem; margin-bottom: 15px;">
                Customize team names, colors, and logos for the scorebug overlay.
            </p>

            <!-- Home Team -->
            <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h3 style="color: #4a9eff; margin-bottom: 10px; font-size: 1rem;">Home Team</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #888; font-size: 0.85rem;">Team Name:</label>
                        <input type="text" id="homeTeamName" placeholder="HOME" style="width: 100%; padding: 8px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #888; font-size: 0.85rem;">Short Name:</label>
                        <input type="text" id="homeTeamShort" placeholder="HOM" maxlength="4" style="width: 100%; padding: 8px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #888; font-size: 0.85rem;">Primary Color:</label>
                        <input type="color" id="homeTeamColor" value="#1b6eb8" style="width: 100%; height: 38px; padding: 2px; background: #333; border: 1px solid #555; border-radius: 4px; cursor: pointer;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #888; font-size: 0.85rem;">Secondary Color:</label>
                        <input type="color" id="homeTeamColor2" value="#00529c" style="width: 100%; height: 38px; padding: 2px; background: #333; border: 1px solid #555; border-radius: 4px; cursor: pointer;">
                    </div>
                    <div style="grid-column: span 2;">
                        <label style="display: block; margin-bottom: 5px; color: #888; font-size: 0.85rem;">Logo:</label>
                        <select id="homeTeamLogo" style="width: 100%; padding: 8px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px;">
                            <option value="home.png">home.png (default)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Away Team -->
            <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h3 style="color: #ff4a4a; margin-bottom: 10px; font-size: 1rem;">Away Team</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #888; font-size: 0.85rem;">Team Name:</label>
                        <input type="text" id="awayTeamName" placeholder="AWAY" style="width: 100%; padding: 8px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #888; font-size: 0.85rem;">Short Name:</label>
                        <input type="text" id="awayTeamShort" placeholder="AWY" maxlength="4" style="width: 100%; padding: 8px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #888; font-size: 0.85rem;">Primary Color:</label>
                        <input type="color" id="awayTeamColor" value="#aa0000" style="width: 100%; height: 38px; padding: 2px; background: #333; border: 1px solid #555; border-radius: 4px; cursor: pointer;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #888; font-size: 0.85rem;">Secondary Color:</label>
                        <input type="color" id="awayTeamColor2" value="#780000" style="width: 100%; height: 38px; padding: 2px; background: #333; border: 1px solid #555; border-radius: 4px; cursor: pointer;">
                    </div>
                    <div style="grid-column: span 2;">
                        <label style="display: block; margin-bottom: 5px; color: #888; font-size: 0.85rem;">Logo:</label>
                        <select id="awayTeamLogo" style="width: 100%; padding: 8px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px;">
                            <option value="away.png">away.png (default)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Logo Upload -->
            <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                <h3 style="color: #888; margin-bottom: 10px; font-size: 1rem;">Upload Logo</h3>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="file" id="logoUpload" accept=".png,.jpg,.jpeg,.svg,.gif,.webp" style="flex: 1; padding: 8px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px;">
                    <button class="btn btn-primary" onclick="uploadLogo()">Upload</button>
                </div>
                <div id="uploadStatus" style="margin-top: 10px; font-size: 0.85rem; color: #888;"></div>
            </div>

            <div class="controls">
                <button class="btn btn-success" onclick="applyTeamConfig()">Apply Changes</button>
                <button class="btn btn-secondary" onclick="refreshTeamConfig()">Refresh</button>
                <button class="btn btn-warning" onclick="resetTeamConfig()">Reset to Default</button>
            </div>
            <div id="teamConfigStatus" style="margin-top: 10px; font-size: 0.85rem; color: #888;"></div>
        </div>

        <!-- Roster Manager -->
        <div class="card" style="grid-column: 1 / -1;">
            <h2>Team Rosters</h2>
            <p style="color: #888; font-size: 0.9rem; margin-bottom: 15px;">
                Manage player names and numbers for quick overlay insertion. Select a player to show their card on broadcast.
            </p>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- Home Roster -->
                <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; border-left: 4px solid #4a9eff;">
                    <h3 style="color: #4a9eff; margin-bottom: 15px; font-size: 1.1rem;">Home Roster</h3>
                    <div id="homeRosterList" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;"></div>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        <input type="text" id="homePlayerNum" placeholder="#" style="width: 50px; padding: 8px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px;" maxlength="3">
                        <input type="text" id="homePlayerName" placeholder="Name" style="flex: 1; min-width: 100px; padding: 8px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px;">
                        <select id="homePlayerPos" style="padding: 8px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px;">
                            <option value="G">G</option>
                            <option value="D">D</option>
                            <option value="C">C</option>
                            <option value="LW">LW</option>
                            <option value="RW">RW</option>
                            <option value="F" selected>F</option>
                        </select>
                        <button class="btn btn-sm btn-home" onclick="addRosterPlayer('home')">Add</button>
                    </div>
                </div>

                <!-- Away Roster -->
                <div style="background: #1a1a1a; padding: 15px; border-radius: 8px; border-left: 4px solid #ff4a4a;">
                    <h3 style="color: #ff4a4a; margin-bottom: 15px; font-size: 1.1rem;">Away Roster</h3>
                    <div id="awayRosterList" style="max-height: 300px; overflow-y: auto; margin-bottom: 15px;"></div>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        <input type="text" id="awayPlayerNum" placeholder="#" style="width: 50px; padding: 8px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px;" maxlength="3">
                        <input type="text" id="awayPlayerName" placeholder="Name" style="flex: 1; min-width: 100px; padding: 8px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px;">
                        <select id="awayPlayerPos" style="padding: 8px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px;">
                            <option value="G">G</option>
                            <option value="D">D</option>
                            <option value="C">C</option>
                            <option value="LW">LW</option>
                            <option value="RW">RW</option>
                            <option value="F" selected>F</option>
                        </select>
                        <button class="btn btn-sm btn-away" onclick="addRosterPlayer('away')">Add</button>
                    </div>
                </div>
            </div>

            <div class="controls" style="margin-top: 20px; justify-content: center;">
                <button class="btn btn-secondary" onclick="refreshRosters()">Refresh Rosters</button>
                <button class="btn btn-warning" onclick="resetRosterStats()">Reset Game Stats</button>
            </div>
        </div>
    </div>

    <script src="/static/js/socket.io.min.js"></script>
    <script>
        // WebSocket connection
        const socket = io();

        // State
        let currentState = {
            game: { home: 0, away: 0, period: "1", clock: "20:00", home_penalties: [], away_penalties: [] },
            bug_visible: true,
            simulator_running: false,
            serial_connected: false,
            caspar_connected: false
        };

        // Socket events
        socket.on('connect', () => {
            console.log('Connected to SLAP server');
            document.getElementById('wsStatus').classList.add('connected');
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from SLAP server');
            document.getElementById('wsStatus').classList.remove('connected');
        });

        socket.on('state_update', (state) => {
            currentState = state;
            updateUI();
        });

        // Update UI from state
        function updateUI() {
            const game = currentState.game;

            // Scores
            document.getElementById('homeScore').textContent = game.home;
            document.getElementById('awayScore').textContent = game.away;

            // Period
            let periodText = game.period;
            if (periodText === "1") periodText = "1st";
            else if (periodText === "2") periodText = "2nd";
            else if (periodText === "3") periodText = "3rd";
            document.getElementById('period').textContent = periodText;
            document.getElementById('periodSelect').value = game.period;

            // Clock
            document.getElementById('clock').textContent = game.clock;
            document.getElementById('clockInput').value = game.clock;

            // Penalties
            const homePens = game.home_penalties || [];
            const awayPens = game.away_penalties || [];
            document.getElementById('homePenalties').textContent =
                homePens.length ? homePens.map(formatPenalty).join(', ') : 'None';
            document.getElementById('awayPenalties').textContent =
                awayPens.length ? awayPens.map(formatPenalty).join(', ') : 'None';

            // Status indicators
            updateStatus('simStatus', currentState.simulator_running);
            updateStatus('bugStatus', currentState.bug_visible);
            updateStatus('serialStatus', currentState.serial_connected);
            updateStatus('casparStatus', currentState.caspar_connected);

            // Update scorebug preview
            updateScorebugPreview();
        }

        function formatPenalty(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        function updateStatus(id, connected) {
            const el = document.getElementById(id);
            if (connected) {
                el.classList.add('connected');
            } else {
                el.classList.remove('connected');
            }
        }

        function updateScorebugPreview() {
            const iframe = document.getElementById('scorebugPreview');
            if (iframe.contentWindow && iframe.contentWindow.updateFromParent) {
                iframe.contentWindow.updateFromParent(currentState.game);
            }
        }

        // API calls
        async function api(endpoint, method = 'GET', data = null) {
            const options = { method, headers: { 'Content-Type': 'application/json' } };
            if (data) options.body = JSON.stringify(data);
            const response = await fetch(`/api${endpoint}`, options);
            return response.json();
        }

        // Control functions
        function startSimulator() { api('/simulator/start', 'POST'); }
        function stopSimulator() { api('/simulator/stop', 'POST'); }
        function resetSimulator() { api('/simulator/reset', 'POST'); }

        function triggerGoal(side) { api('/goal', 'POST', { side }); }

        function adjustScore(team, delta) {
            const newScore = Math.max(0, currentState.game[team === 'home' ? 'home' : 'away'] + delta);
            const data = team === 'home' ? { home: newScore } : { away: newScore };
            api('/state', 'POST', data);
        }

        function updatePeriod() {
            const period = document.getElementById('periodSelect').value;
            api('/state', 'POST', { period });
        }

        function updateClock() {
            const clock = document.getElementById('clockInput').value;
            api('/state', 'POST', { clock });
        }

        function addPenalty(side, duration) {
            api('/penalty', 'POST', { side, duration });
        }

        function showBug() { api('/bug/show', 'POST'); }
        function hideBug() { api('/bug/hide', 'POST'); }

        // Mode switching
        let currentMode = 'preview';

        async function setMode(mode) {
            const result = await api('/mode', 'POST', { mode });
            if (result.status === 'ok') {
                currentMode = result.mode;
                updateModeUI();
            }
        }

        function updateModeUI() {
            const indicator = document.getElementById('modeIndicator');
            const btnPreview = document.getElementById('btnPreview');
            const btnLive = document.getElementById('btnLive');
            const title = document.getElementById('previewTitle');

            // Update indicator
            indicator.className = 'mode-indicator ' + currentMode;
            indicator.textContent = currentMode.toUpperCase();

            // Update buttons
            btnPreview.classList.toggle('active', currentMode === 'preview');
            btnLive.classList.toggle('active', currentMode === 'live');

            // Update title
            title.textContent = currentMode === 'preview' ? 'Preview' : 'Live Output';
        }

        // Listen for mode changes from server
        socket.on('mode_change', (data) => {
            currentMode = data.mode;
            updateModeUI();
        });

        // Initial state fetch
        api('/state').then(state => {
            currentState = state;
            updateUI();
        });

        // Get initial mode
        api('/mode').then(data => {
            currentMode = data.mode;
            updateModeUI();
        });

        // CasparCG Server Control
        let casparState = {
            installed: false,
            running: false,
            amcp_listening: false,
            connected: false,
            binary: null
        };

        async function casparRefresh() {
            try {
                const status = await api('/caspar/status');
                casparState = status;
                updateCasparUI();
            } catch (e) {
                console.error('Failed to get CasparCG status:', e);
            }
        }

        function updateCasparUI() {
            updateStatus('casparInstalled', casparState.installed);
            updateStatus('casparRunning', casparState.running);
            updateStatus('casparAmcp', casparState.amcp_listening);

            const info = document.getElementById('casparInfo');
            if (casparState.installed) {
                let text = `Binary: ${casparState.binary || 'found'}`;
                if (casparState.running && casparState.pid) {
                    text += ` | PID: ${casparState.pid}`;
                }
                if (casparState.amcp_listening) {
                    text += ' | AMCP: port 5250';
                }
                info.textContent = text;
            } else {
                info.innerHTML = 'Not installed. Run: <code>./deploy.sh caspar-install</code>';
            }

            // Update button states
            document.getElementById('btnCasparStart').disabled = !casparState.installed || casparState.running;
            document.getElementById('btnCasparStop').disabled = !casparState.running;
            document.getElementById('btnCasparConnect').disabled = !casparState.amcp_listening;
        }

        async function casparStart() {
            document.getElementById('btnCasparStart').disabled = true;
            document.getElementById('btnCasparStart').textContent = 'Starting...';
            try {
                await api('/caspar/start', 'POST');
                // Wait for it to start
                setTimeout(casparRefresh, 3000);
            } catch (e) {
                alert('Failed to start CasparCG: ' + e.message);
            }
            document.getElementById('btnCasparStart').textContent = 'Start Server';
        }

        async function casparStop() {
            document.getElementById('btnCasparStop').disabled = true;
            try {
                await api('/caspar/stop', 'POST');
                setTimeout(casparRefresh, 1000);
            } catch (e) {
                alert('Failed to stop CasparCG: ' + e.message);
            }
        }

        async function casparConnect() {
            document.getElementById('btnCasparConnect').disabled = true;
            document.getElementById('btnCasparConnect').textContent = 'Connecting...';
            try {
                const result = await api('/caspar/connect', 'POST');
                if (result.connected) {
                    updateStatus('casparStatus', true);
                }
            } catch (e) {
                alert('Failed to connect to CasparCG');
            }
            document.getElementById('btnCasparConnect').textContent = 'Connect';
            casparRefresh();
        }

        // Initial CasparCG status check
        casparRefresh();
        // Refresh CasparCG status every 10 seconds
        setInterval(casparRefresh, 10000);

        // OBS Studio Control
        let obsState = {
            installed: false,
            running: false,
            websocket_listening: false,
            connected: false,
            binary: null,
            version: null,
            current_scene: null
        };

        async function obsRefresh() {
            try {
                const status = await api('/obs/status');
                obsState = status;
                updateObsUI();
            } catch (e) {
                console.error('Failed to get OBS status:', e);
            }
        }

        function updateObsUI() {
            updateStatus('obsInstalled', obsState.installed);
            updateStatus('obsRunning', obsState.running);
            updateStatus('obsWebsocket', obsState.websocket_listening);
            updateStatus('obsConnected', obsState.connected);

            const info = document.getElementById('obsInfo');
            const scorebugCard = document.getElementById('obsScorebuCard');
            const sceneInfo = document.getElementById('obsSceneInfo');

            if (obsState.installed) {
                let text = `Binary: ${obsState.binary || 'found'}`;
                if (obsState.running && obsState.pid) {
                    text += ` | PID: ${obsState.pid}`;
                }
                if (obsState.connected && obsState.current_scene) {
                    text += ` | Scene: ${obsState.current_scene}`;
                }
                info.textContent = text;

                // Show WebSocket setup instructions if not listening
                if (obsState.running && !obsState.websocket_listening) {
                    info.innerHTML = text + '<br><span style="color: #ffc107;">Enable WebSocket: Tools &gt; WebSocket Server Settings</span>';
                }
            } else {
                info.innerHTML = 'Not installed. Download from <a href="https://obsproject.com/" target="_blank" style="color: #00d4ff;">obsproject.com</a>';
            }

            // Show scorebug card if connected
            if (obsState.connected) {
                scorebugCard.style.display = 'block';
                sceneInfo.textContent = `Current scene: ${obsState.current_scene || 'unknown'}`;
            } else {
                scorebugCard.style.display = 'none';
            }

            // Update button states
            document.getElementById('btnObsStart').disabled = !obsState.installed || obsState.running;
            document.getElementById('btnObsStop').disabled = !obsState.running;
            document.getElementById('btnObsConnect').disabled = !obsState.websocket_listening || obsState.connected;
        }

        async function obsStart() {
            document.getElementById('btnObsStart').disabled = true;
            document.getElementById('btnObsStart').textContent = 'Starting...';
            try {
                await api('/obs/start', 'POST');
                setTimeout(obsRefresh, 3000);
            } catch (e) {
                alert('Failed to start OBS: ' + e.message);
            }
            document.getElementById('btnObsStart').textContent = 'Start OBS';
        }

        async function obsStop() {
            document.getElementById('btnObsStop').disabled = true;
            try {
                await api('/obs/stop', 'POST');
                setTimeout(obsRefresh, 1000);
            } catch (e) {
                alert('Failed to stop OBS: ' + e.message);
            }
        }

        async function obsConnect() {
            document.getElementById('btnObsConnect').disabled = true;
            document.getElementById('btnObsConnect').textContent = 'Connecting...';
            try {
                const result = await api('/obs/connect', 'POST');
                if (result.connected) {
                    obsState.connected = true;
                    obsState.current_scene = result.current_scene;
                    obsState.version = result.version;
                    updateObsUI();
                } else {
                    alert('Failed to connect: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Failed to connect to OBS WebSocket. Make sure it\'s enabled in OBS.');
            }
            document.getElementById('btnObsConnect').textContent = 'Connect';
            obsRefresh();
        }

        async function obsSetupScoreBug() {
            try {
                const result = await api('/obs/setup-scorebug', 'POST');
                if (result.status === 'ok') {
                    alert('Scorebug overlay added to scene: ' + result.source_name);
                    obsRefresh();
                } else {
                    alert('Failed to add scorebug: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Failed to add scorebug overlay');
            }
        }

        async function obsShowScoreBug() {
            try {
                await api('/obs/scorebug/show', 'POST');
            } catch (e) {
                alert('Failed to show scorebug');
            }
        }

        async function obsHideScoreBug() {
            try {
                await api('/obs/scorebug/hide', 'POST');
            } catch (e) {
                alert('Failed to hide scorebug');
            }
        }

        async function obsRefreshScoreBug() {
            try {
                await api('/obs/scorebug/refresh', 'POST');
            } catch (e) {
                alert('Failed to refresh scorebug');
            }
        }

        // ============ Serial Port Control ============
        let serialState = {
            connected: false,
            simulator_mode: false,
            configured_port: '',
            baudrate: 9600,
            ports: []
        };

        async function serialRefreshPorts() {
            try {
                const ports = await api('/serial/ports');
                serialState.ports = ports.ports || [];

                const select = document.getElementById('serialPortSelect');
                select.innerHTML = '<option value="">-- Select Port --</option>';

                for (const port of serialState.ports) {
                    const opt = document.createElement('option');
                    opt.value = port.device;
                    opt.textContent = `${port.device} - ${port.description}`;
                    if (port.device === serialState.configured_port) {
                        opt.selected = true;
                    }
                    select.appendChild(opt);
                }
            } catch (e) {
                console.error('Failed to get serial ports:', e);
            }
        }

        async function serialRefreshStatus() {
            try {
                const status = await api('/serial/status');
                serialState.connected = status.connected;
                serialState.simulator_mode = status.simulator_mode;
                serialState.configured_port = status.configured_port;
                serialState.baudrate = status.baudrate;

                updateSerialUI();
            } catch (e) {
                console.error('Failed to get serial status:', e);
            }
        }

        function updateSerialUI() {
            updateStatus('serialConnected', serialState.connected);
            updateStatus('serialSimMode', serialState.simulator_mode);

            const info = document.getElementById('serialInfo');
            if (serialState.simulator_mode) {
                info.textContent = 'Running in SIMULATION mode (fake data)';
                info.style.color = '#ff0';
            } else if (serialState.connected) {
                info.textContent = `Connected to ${serialState.configured_port} @ ${serialState.baudrate} baud`;
                info.style.color = '#0f0';
            } else {
                info.textContent = `Not connected. Configured: ${serialState.configured_port}`;
                info.style.color = '#f00';
            }

            // Update baud rate select
            document.getElementById('serialBaudSelect').value = serialState.baudrate;
        }

        async function serialApplyConfig() {
            const port = document.getElementById('serialPortSelect').value;
            const baudrate = document.getElementById('serialBaudSelect').value;

            if (!port) {
                alert('Please select a serial port');
                return;
            }

            try {
                await api('/serial/config', 'POST', { port, baudrate: parseInt(baudrate) });
                alert('Configuration saved. The server needs to be restarted to apply changes.\n\nRun: python deploy.py restart');
            } catch (e) {
                alert('Failed to save configuration');
            }
        }

        async function toggleSimMode() {
            try {
                await api('/simulator/start', 'POST');
                serialRefreshStatus();
            } catch (e) {
                alert('Failed to toggle simulation mode');
            }
        }

        function viewLogs() {
            const logDiv = document.getElementById('serialLog');
            if (logDiv.style.display === 'none') {
                logDiv.style.display = 'block';
                logDiv.textContent = 'To view serial debug data, run SLAP with --debug flag:\n\npython deploy.py start --debug\n\nThen check logs:\npython deploy.py logs -f';
            } else {
                logDiv.style.display = 'none';
            }
        }

        // Initial serial status check
        serialRefreshStatus();
        serialRefreshPorts();
        // Refresh serial status every 5 seconds
        setInterval(serialRefreshStatus, 5000);

        // ============ Team Customization ============
        let teamConfig = {
            home: { name: 'HOME', short_name: 'HOM', logo: 'home.png', primary_color: '#1b6eb8', secondary_color: '#00529c' },
            away: { name: 'AWAY', short_name: 'AWY', logo: 'away.png', primary_color: '#aa0000', secondary_color: '#780000' }
        };

        async function refreshTeamConfig() {
            try {
                const teams = await api('/teams');
                teamConfig = teams;

                // Update form fields
                document.getElementById('homeTeamName').value = teams.home.name || '';
                document.getElementById('homeTeamShort').value = teams.home.short_name || '';
                document.getElementById('homeTeamColor').value = teams.home.primary_color || '#1b6eb8';
                document.getElementById('homeTeamColor2').value = teams.home.secondary_color || '#00529c';

                document.getElementById('awayTeamName').value = teams.away.name || '';
                document.getElementById('awayTeamShort').value = teams.away.short_name || '';
                document.getElementById('awayTeamColor').value = teams.away.primary_color || '#aa0000';
                document.getElementById('awayTeamColor2').value = teams.away.secondary_color || '#780000';

                // Load logo options
                await refreshLogoOptions();

                // Set current logo selections
                document.getElementById('homeTeamLogo').value = teams.home.logo || 'home.png';
                document.getElementById('awayTeamLogo').value = teams.away.logo || 'away.png';

            } catch (e) {
                console.error('Failed to load team config:', e);
            }
        }

        async function refreshLogoOptions() {
            try {
                const result = await api('/teams/logos');
                const logos = result.logos || [];

                const homeSelect = document.getElementById('homeTeamLogo');
                const awaySelect = document.getElementById('awayTeamLogo');

                // Clear and repopulate
                homeSelect.innerHTML = '';
                awaySelect.innerHTML = '';

                for (const logo of logos) {
                    homeSelect.innerHTML += `<option value="${logo}">${logo}</option>`;
                    awaySelect.innerHTML += `<option value="${logo}">${logo}</option>`;
                }

                if (logos.length === 0) {
                    homeSelect.innerHTML = '<option value="home.png">home.png</option>';
                    awaySelect.innerHTML = '<option value="away.png">away.png</option>';
                }
            } catch (e) {
                console.error('Failed to load logos:', e);
            }
        }

        async function applyTeamConfig() {
            const config = {
                home: {
                    name: document.getElementById('homeTeamName').value || 'HOME',
                    short_name: document.getElementById('homeTeamShort').value || 'HOM',
                    logo: document.getElementById('homeTeamLogo').value || 'home.png',
                    color: document.getElementById('homeTeamColor').value,
                    primary_color: document.getElementById('homeTeamColor').value,
                    secondary_color: document.getElementById('homeTeamColor2').value
                },
                away: {
                    name: document.getElementById('awayTeamName').value || 'AWAY',
                    short_name: document.getElementById('awayTeamShort').value || 'AWY',
                    logo: document.getElementById('awayTeamLogo').value || 'away.png',
                    color: document.getElementById('awayTeamColor').value,
                    primary_color: document.getElementById('awayTeamColor').value,
                    secondary_color: document.getElementById('awayTeamColor2').value
                }
            };

            try {
                await api('/teams', 'POST', config);
                document.getElementById('teamConfigStatus').textContent = 'Team configuration applied!';
                document.getElementById('teamConfigStatus').style.color = '#0f0';

                // Update scorebug preview
                updateScorebugPreview(config);

                setTimeout(() => {
                    document.getElementById('teamConfigStatus').textContent = '';
                }, 3000);
            } catch (e) {
                document.getElementById('teamConfigStatus').textContent = 'Failed to apply team configuration';
                document.getElementById('teamConfigStatus').style.color = '#f00';
            }
        }

        function updateScorebugPreview(config) {
            // Send to preview iframe if available
            const preview = document.getElementById('scorebugPreview');
            if (preview && preview.contentWindow) {
                preview.contentWindow.postMessage({
                    type: 'team_config',
                    data: config
                }, '*');
            }
        }

        function resetTeamConfig() {
            document.getElementById('homeTeamName').value = 'HOME';
            document.getElementById('homeTeamShort').value = 'HOM';
            document.getElementById('homeTeamColor').value = '#1b6eb8';
            document.getElementById('homeTeamColor2').value = '#00529c';
            document.getElementById('homeTeamLogo').value = 'home.png';

            document.getElementById('awayTeamName').value = 'AWAY';
            document.getElementById('awayTeamShort').value = 'AWY';
            document.getElementById('awayTeamColor').value = '#aa0000';
            document.getElementById('awayTeamColor2').value = '#780000';
            document.getElementById('awayTeamLogo').value = 'away.png';

            document.getElementById('teamConfigStatus').textContent = 'Reset to defaults. Click "Apply" to save.';
            document.getElementById('teamConfigStatus').style.color = '#ff0';
        }

        async function uploadLogo() {
            const fileInput = document.getElementById('logoUpload');
            const statusDiv = document.getElementById('uploadStatus');

            if (!fileInput.files || fileInput.files.length === 0) {
                statusDiv.textContent = 'Please select a file first';
                statusDiv.style.color = '#f00';
                return;
            }

            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);

            statusDiv.textContent = 'Uploading...';
            statusDiv.style.color = '#888';

            try {
                const response = await fetch('/api/teams/logo/upload', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();

                if (result.status === 'ok') {
                    statusDiv.textContent = `Uploaded: ${result.filename}`;
                    statusDiv.style.color = '#0f0';
                    fileInput.value = '';
                    await refreshLogoOptions();
                } else {
                    statusDiv.textContent = `Error: ${result.error}`;
                    statusDiv.style.color = '#f00';
                }
            } catch (e) {
                statusDiv.textContent = 'Upload failed';
                statusDiv.style.color = '#f00';
            }
        }

        // Initial team config load
        refreshTeamConfig();

        // Initial OBS status check
        obsRefresh();
        // Refresh OBS status every 10 seconds
        setInterval(obsRefresh, 10000);

        // ============ Broadcast Overlay Controls ============

        async function triggerGoalSplash(team) {
            await api('/overlay/goal', 'POST', {
                team: team,
                duration: 5000
            });
        }

        async function hideOverlay(overlay) {
            await api(`/overlay/${overlay}/hide`, 'POST');
        }

        async function showReplay() {
            await api('/overlay/replay', 'POST', { duration: 5000 });
        }

        async function showPlayerCard(team) {
            const num = document.getElementById('playerNum').value || '00';
            const name = document.getElementById('playerName').value || 'PLAYER';
            await api('/overlay/player', 'POST', {
                team: team,
                number: num,
                name: name,
                duration: 5000
            });
        }

        async function showGoalieStats() {
            const num = document.getElementById('goalieNum').value || '00';
            const saves = parseInt(document.getElementById('goalieSaves').value) || 0;
            const shots = parseInt(document.getElementById('goalieShots').value) || 0;
            await api('/overlay/goalie', 'POST', {
                number: num,
                name: 'GOALIE',
                saves: saves,
                shots: shots,
                gaa: 2.50,
                duration: 6000
            });
        }

        async function showPeriodSummary() {
            await api('/overlay/period', 'POST', { duration: 8000 });
        }

        async function showGameIntro() {
            await api('/overlay/intro', 'POST', {
                homeTeam: teamConfig.home?.name || 'HOME',
                awayTeam: teamConfig.away?.name || 'AWAY',
                homeRecord: '0-0-0',
                awayRecord: '0-0-0',
                venue: 'Arena',
                duration: 8000
            });
        }

        async function showThreeStars() {
            await api('/overlay/stars', 'POST', {
                star1: { number: '87', name: '1ST STAR', goals: 2, assists: 1 },
                star2: { number: '71', name: '2ND STAR', goals: 1, assists: 2 },
                star3: { number: '30', name: '3RD STAR', saves: 35 },
                duration: 10000
            });
        }

        async function showPowerPlay(team) {
            await api('/overlay/powerplay', 'POST', {
                team: team,
                homeStrength: team === 'home' ? 5 : 4,
                awayStrength: team === 'away' ? 5 : 4,
                duration: 120
            });
        }

        async function updateShotCounter() {
            const home = parseInt(document.getElementById('homeShots').value) || 0;
            const away = parseInt(document.getElementById('awayShots').value) || 0;
            await api('/overlay/shots', 'POST', { home: home, away: away });
        }

        async function addPenaltyOverlay(team) {
            await api('/overlay/penalty/add', 'POST', {
                team: team,
                number: '00',
                name: 'PLAYER',
                type: '2 MIN - MINOR',
                duration: 120
            });
        }

        async function showTicker() {
            await api('/overlay/ticker', 'POST', {
                label: 'SCORES',
                scores: [
                    { away: 'NYR', awayScore: 3, home: 'BOS', homeScore: 2, status: 'FINAL', final: true },
                    { away: 'TOR', awayScore: 4, home: 'MTL', homeScore: 1, status: 'FINAL', final: true },
                    { away: 'DET', awayScore: 2, home: 'CHI', homeScore: 2, status: '3RD' }
                ]
            });
        }

        // ============ Roster Management ============

        let rosters = { home: { players: [] }, away: { players: [] } };

        async function refreshRosters() {
            try {
                rosters = await api('/roster');
                renderRoster('home');
                renderRoster('away');
            } catch (e) {
                console.error('Failed to load rosters:', e);
            }
        }

        function renderRoster(team) {
            const list = document.getElementById(team + 'RosterList');
            const players = rosters[team]?.players || [];
            const teamColor = team === 'home' ? '#4a9eff' : '#ff4a4a';

            if (players.length === 0) {
                list.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No players added yet</div>';
                return;
            }

            list.innerHTML = players.map(p => `
                <div style="display: flex; align-items: center; gap: 10px; padding: 8px; margin-bottom: 5px; background: #222; border-radius: 4px; border-left: 3px solid ${teamColor};">
                    <span style="font-weight: bold; color: ${teamColor}; min-width: 35px;">#${p.number}</span>
                    <span style="flex: 1; color: #fff;">${p.name}</span>
                    <span style="color: #888; font-size: 0.8rem; min-width: 30px;">${p.position}</span>
                    <span style="color: #0f0; font-size: 0.8rem;" title="Goals">${p.goals || 0}G</span>
                    <span style="color: #ff0; font-size: 0.8rem;" title="Assists">${p.assists || 0}A</span>
                    <button class="btn btn-sm btn-primary" onclick="showPlayerFromRoster('${team}', '${p.number}')" title="Show Player Card" style="padding: 4px 8px;">Show</button>
                    <button class="btn btn-sm" onclick="addGoalToPlayer('${team}', '${p.number}')" title="Add Goal" style="padding: 4px 8px; background: #0f0; color: #000;">+G</button>
                    <button class="btn btn-sm" onclick="addAssistToPlayer('${team}', '${p.number}')" title="Add Assist" style="padding: 4px 8px; background: #ff0; color: #000;">+A</button>
                    <button class="btn btn-sm btn-danger" onclick="removeRosterPlayer('${team}', '${p.number}')" title="Remove" style="padding: 4px 8px;">X</button>
                </div>
            `).join('');
        }

        async function addRosterPlayer(team) {
            const numInput = document.getElementById(team + 'PlayerNum');
            const nameInput = document.getElementById(team + 'PlayerName');
            const posSelect = document.getElementById(team + 'PlayerPos');

            const number = numInput.value.trim();
            const name = nameInput.value.trim();
            const position = posSelect.value;

            if (!number) {
                alert('Player number is required');
                return;
            }

            try {
                await api(`/roster/${team}/player`, 'POST', { number, name: name || 'PLAYER', position });
                numInput.value = '';
                nameInput.value = '';
                await refreshRosters();
            } catch (e) {
                alert('Failed to add player');
            }
        }

        async function removeRosterPlayer(team, number) {
            if (!confirm(`Remove player #${number}?`)) return;

            try {
                await api(`/roster/${team}/player/${number}`, 'DELETE');
                await refreshRosters();
            } catch (e) {
                alert('Failed to remove player');
            }
        }

        async function showPlayerFromRoster(team, number) {
            const player = rosters[team]?.players?.find(p => p.number === number);
            if (!player) return;

            await api('/overlay/player', 'POST', {
                team: team,
                number: player.number,
                name: player.name,
                position: player.position,
                goals: player.goals || 0,
                assists: player.assists || 0,
                duration: 5000
            });
        }

        async function addGoalToPlayer(team, number) {
            try {
                await api(`/roster/${team}/player/${number}/stats`, 'POST', { add_goal: true });
                await refreshRosters();
            } catch (e) {
                alert('Failed to update stats');
            }
        }

        async function addAssistToPlayer(team, number) {
            try {
                await api(`/roster/${team}/player/${number}/stats`, 'POST', { add_assist: true });
                await refreshRosters();
            } catch (e) {
                alert('Failed to update stats');
            }
        }

        async function resetRosterStats() {
            if (!confirm('Reset all player stats to zero? (Goals, Assists)')) return;

            try {
                await api('/roster/reset', 'POST');
                await refreshRosters();
            } catch (e) {
                alert('Failed to reset stats');
            }
        }

        // Update player card function to use roster
        async function showPlayerCard(team) {
            const num = document.getElementById('playerNum').value || '00';
            const name = document.getElementById('playerName').value || 'PLAYER';

            // Try to find player in roster
            const player = rosters[team]?.players?.find(p => p.number === num);

            await api('/overlay/player', 'POST', {
                team: team,
                number: num,
                name: player ? player.name : name,
                position: player?.position || 'F',
                goals: player?.goals || 0,
                assists: player?.assists || 0,
                duration: 5000
            });
        }

        // Listen for roster updates via socket
        socket.on('roster_update', (data) => {
            if (data.home) rosters.home = data.home;
            if (data.away) rosters.away = data.away;
            if (data.home) renderRoster('home');
            if (data.away) renderRoster('away');
        });

        // Initial roster load
        refreshRosters();
    </script>
</body>
</html>
