<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLAP - Scoreboard Live Automation Platform</title>
    <link rel="icon" type="image/png" href="/static/img/favicon.png">
    <style>
        :root {
            --primary: #00d4ff;
            --primary-dark: #00a8cc;
            --secondary: #6366f1;
            --home: #3b82f6;
            --away: #ef4444;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-dark: #0a0a0f;
            --bg-card: rgba(20, 20, 30, 0.8);
            --bg-card-hover: rgba(30, 30, 45, 0.9);
            --bg-input: rgba(15, 15, 25, 0.9);
            --border: rgba(255, 255, 255, 0.08);
            --border-glow: rgba(0, 212, 255, 0.3);
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --text-dim: #64748b;
            --glass: rgba(255, 255, 255, 0.03);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            background-image:
                /* Subtle noise texture overlay */
                url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E"),
                /* Gradient mesh */
                radial-gradient(ellipse at 20% 0%, rgba(0, 212, 255, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 100%, rgba(99, 102, 241, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(16, 185, 129, 0.05) 0%, transparent 60%),
                /* Diagonal line texture */
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 2px,
                    rgba(255, 255, 255, 0.005) 2px,
                    rgba(255, 255, 255, 0.005) 4px
                );
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        /* SLAP Icon Overlay - Watermark */
        .slap-watermark {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            opacity: 0.15;
            pointer-events: none;
            z-index: 1000;
            filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.3));
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Live Update Indicator */
        .live-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            z-index: 999;
            transition: all 0.3s ease;
        }

        .live-indicator.connected {
            border-color: var(--success);
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.2);
        }

        .live-indicator .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--danger);
            animation: pulse 2s infinite;
        }

        .live-indicator.connected .dot {
            background: var(--success);
        }

        .live-indicator .status-text {
            color: #ffffff;
            animation: textPulse 2s infinite;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .live-indicator.connected .status-text {
            color: var(--success);
            text-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        @keyframes textPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .header-content {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .header-logo {
            width: 100px;
            height: 100px;
            filter: drop-shadow(0 0 30px rgba(0, 212, 255, 0.5));
            animation: glow 3s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { filter: drop-shadow(0 0 20px rgba(0, 212, 255, 0.4)); }
            to { filter: drop-shadow(0 0 40px rgba(0, 212, 255, 0.7)); }
        }

        .header h1 {
            font-size: 2.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1px;
        }

        .header .subtitle {
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 500;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* Mode Toggle */
        .mode-toggle {
            display: flex;
            justify-content: center;
            gap: 0;
            margin-top: 20px;
        }

        .mode-btn {
            padding: 12px 40px;
            border: 2px solid var(--primary);
            background: transparent;
            color: var(--primary);
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .mode-btn:first-child {
            border-radius: 12px 0 0 12px;
        }

        .mode-btn:last-child {
            border-radius: 0 12px 12px 0;
            border-left: none;
        }

        .mode-btn.active {
            background: var(--primary);
            color: var(--bg-dark);
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.4);
        }

        .mode-btn.live {
            border-color: var(--danger);
            color: var(--danger);
        }

        .mode-btn.live.active {
            background: var(--danger);
            color: white;
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.4);
        }

        .mode-indicator {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-left: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .mode-indicator.preview {
            background: var(--primary);
            color: var(--bg-dark);
        }

        .mode-indicator.live {
            background: var(--danger);
            color: white;
            animation: live-pulse 1.5s infinite;
        }

        @keyframes live-pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 20px rgba(239, 68, 68, 0.5); }
            50% { opacity: 0.8; box-shadow: 0 0 40px rgba(239, 68, 68, 0.8); }
        }

        /* Container */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        @media (max-width: 1200px) {
            .container { grid-template-columns: 1fr; }
        }

        /* Cards */
        .card {
            background: linear-gradient(
                135deg,
                rgba(20, 20, 35, 0.9) 0%,
                rgba(15, 15, 25, 0.85) 50%,
                rgba(20, 20, 35, 0.9) 100%
            );
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        /* Subtle inner glow effect */
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(0, 212, 255, 0.3) 50%,
                transparent 100%
            );
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .card:hover {
            background: linear-gradient(
                135deg,
                rgba(30, 30, 50, 0.95) 0%,
                rgba(20, 20, 35, 0.9) 50%,
                rgba(30, 30, 50, 0.95) 100%
            );
            border-color: var(--border-glow);
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(0, 212, 255, 0.1) inset;
            transform: translateY(-2px);
        }

        .card:hover::before {
            opacity: 1;
        }

        .card h2 {
            color: var(--text);
            margin-bottom: 20px;
            font-size: 1.1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card h2::before {
            content: '';
            width: 4px;
            height: 24px;
            background: linear-gradient(180deg, var(--primary), var(--secondary));
            border-radius: 2px;
        }

        .card h2 .icon {
            width: 24px;
            height: 24px;
            opacity: 0.7;
        }

        /* Preview Container */
        .preview-container {
            grid-column: 1 / -1;
        }

        .preview-frame {
            width: 100%;
            aspect-ratio: 16/9;
            background: linear-gradient(
                135deg,
                #0a0a12 0%,
                #12121f 25%,
                #1a1a2e 50%,
                #12121f 75%,
                #0a0a12 100%
            );
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            border: 2px solid transparent;
            background-clip: padding-box;
            box-shadow:
                0 0 0 1px rgba(0, 212, 255, 0.1),
                0 10px 40px rgba(0, 0, 0, 0.5),
                inset 0 0 100px rgba(0, 212, 255, 0.02);
        }

        .preview-frame::before {
            content: '';
            position: absolute;
            inset: 0;
            background:
                url('/static/img/SLAP_icon.webp') center center no-repeat,
                radial-gradient(ellipse at center, rgba(0, 212, 255, 0.03) 0%, transparent 70%);
            background-size: 120px, cover;
            opacity: 0.5;
            pointer-events: none;
        }

        .preview-frame::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(0, 212, 255, 0.5) 50%,
                transparent 100%
            );
        }

        .preview-frame iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Score Display */
        .score-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 40px;
            padding: 30px 20px;
        }

        .team {
            text-align: center;
            flex: 1;
        }

        .team-name {
            font-size: 1rem;
            color: var(--text-muted);
            margin-bottom: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .team-score {
            font-size: 5rem;
            font-weight: 800;
            line-height: 1;
            text-shadow:
                0 0 40px currentColor,
                0 0 80px currentColor;
            transition: all 0.3s ease;
        }

        .team-score:hover {
            transform: scale(1.05);
            text-shadow:
                0 0 50px currentColor,
                0 0 100px currentColor;
        }

        .team-score.home {
            color: var(--home);
            background: linear-gradient(180deg, #60a5fa 0%, var(--home) 50%, #2563eb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .team-score.away {
            color: var(--away);
            background: linear-gradient(180deg, #f87171 0%, var(--away) 50%, #dc2626 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .vs {
            font-size: 1.5rem;
            color: var(--text-dim);
            font-weight: 300;
        }

        /* Game Info */
        .game-info {
            display: flex;
            justify-content: center;
            gap: 60px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .info-item {
            text-align: center;
        }

        .info-label {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .info-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text);
        }

        /* Buttons */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }

        /* Shine effect on buttons */
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                120deg,
                transparent 0%,
                rgba(255, 255, 255, 0.2) 50%,
                transparent 100%
            );
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
        }

        .btn:active {
            transform: translateY(-1px) scale(1.01);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.25);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn:disabled::before {
            display: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 50%, var(--primary) 100%);
            background-size: 200% 200%;
            color: var(--bg-dark);
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }

        .btn-primary:hover {
            background-position: 100% 100%;
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.5);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 50%, #10b981 100%);
            background-size: 200% 200%;
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            background-position: 100% 100%;
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.5);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 50%, #ef4444 100%);
            background-size: 200% 200%;
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background-position: 100% 100%;
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.5);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 50%, #f59e0b 100%);
            background-size: 200% 200%;
            color: var(--bg-dark);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }

        .btn-warning:hover {
            background-position: 100% 100%;
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.5);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #475569 0%, #334155 50%, #475569 100%);
            background-size: 200% 200%;
            color: white;
            box-shadow: 0 4px 15px rgba(71, 85, 105, 0.3);
        }

        .btn-secondary:hover {
            background-position: 100% 100%;
            box-shadow: 0 8px 25px rgba(71, 85, 105, 0.5);
        }

        .btn-home {
            background: linear-gradient(135deg, var(--home) 0%, #2563eb 50%, var(--home) 100%);
            background-size: 200% 200%;
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .btn-home:hover {
            background-position: 100% 100%;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.5);
        }

        .btn-away {
            background: linear-gradient(135deg, var(--away) 0%, #dc2626 50%, var(--away) 100%);
            background-size: 200% 200%;
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-away:hover {
            background-position: 100% 100%;
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.5);
        }

        .btn-group {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .btn-sm {
            padding: 8px 14px;
            font-size: 0.75rem;
        }

        /* Status indicators */
        .status-bar {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #ff6b6b 0%, var(--danger) 100%);
            transition: all 0.3s ease;
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.4);
        }

        .status-dot.connected {
            background: radial-gradient(circle at 30% 30%, #34d399 0%, var(--success) 100%);
            box-shadow: 0 0 12px rgba(16, 185, 129, 0.6);
            animation: statusPulse 2s ease-in-out infinite;
        }

        @keyframes statusPulse {
            0%, 100% { box-shadow: 0 0 12px rgba(16, 185, 129, 0.6); }
            50% { box-shadow: 0 0 20px rgba(16, 185, 129, 0.9); }
        }

        .status-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        /* Penalties */
        .penalties {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .penalty-box {
            background: linear-gradient(
                145deg,
                rgba(15, 15, 25, 0.95) 0%,
                rgba(20, 20, 35, 0.9) 100%
            );
            padding: 16px 24px;
            border-radius: 12px;
            min-width: 160px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .penalty-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .penalty-box h3 {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .penalty-list {
            font-size: 1.3rem;
            font-weight: 700;
        }

        .penalty-list.home { color: var(--home); }
        .penalty-list.away { color: var(--away); }

        /* Inputs */
        .input-group {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .input-group label {
            min-width: 80px;
            color: var(--text-muted);
            font-size: 0.85rem;
            font-weight: 500;
        }

        input, select {
            background: linear-gradient(
                180deg,
                rgba(15, 15, 25, 0.95) 0%,
                rgba(20, 20, 30, 0.9) 100%
            );
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 14px;
            color: var(--text);
            font-size: 0.9rem;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow:
                0 0 0 3px rgba(0, 212, 255, 0.15),
                0 4px 12px rgba(0, 0, 0, 0.2);
            background: linear-gradient(
                180deg,
                rgba(20, 20, 35, 0.98) 0%,
                rgba(25, 25, 40, 0.95) 100%
            );
        }

        input:hover, select:hover {
            border-color: rgba(255, 255, 255, 0.15);
        }

        /* Overlay Cards Grid */
        .overlay-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }

        .overlay-card {
            background: linear-gradient(
                135deg,
                rgba(15, 15, 25, 0.9) 0%,
                rgba(20, 20, 35, 0.85) 100%
            );
            padding: 16px;
            border-radius: 12px;
            border-left: 4px solid var(--primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .overlay-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 60px;
            height: 60px;
            background: radial-gradient(
                circle at top right,
                rgba(0, 212, 255, 0.1) 0%,
                transparent 70%
            );
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .overlay-card:hover {
            background: linear-gradient(
                135deg,
                rgba(25, 25, 40, 0.95) 0%,
                rgba(30, 30, 50, 0.9) 100%
            );
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        .overlay-card:hover::after {
            opacity: 1;
        }

        .overlay-card h3 {
            color: var(--primary);
            margin-bottom: 12px;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .overlay-card code {
            font-size: 0.7rem;
            color: var(--text-dim);
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.4) 0%, rgba(0, 0, 0, 0.3) 100%);
            padding: 3px 8px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Full Width Cards */
        .full-width {
            grid-column: 1 / -1;
        }

        /* Roster List */
        .roster-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 800px) {
            .roster-container { grid-template-columns: 1fr; }
        }

        .roster-section {
            background: linear-gradient(
                145deg,
                rgba(15, 15, 25, 0.95) 0%,
                rgba(20, 20, 35, 0.9) 100%
            );
            padding: 20px;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        .roster-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                135deg,
                transparent 0%,
                rgba(255, 255, 255, 0.02) 50%,
                transparent 100%
            );
            pointer-events: none;
        }

        .roster-section.home {
            border-left: 4px solid var(--home);
            box-shadow: inset 0 0 30px rgba(59, 130, 246, 0.05);
        }

        .roster-section.away {
            border-left: 4px solid var(--away);
            box-shadow: inset 0 0 30px rgba(239, 68, 68, 0.05);
        }

        .roster-section h3 {
            margin-bottom: 16px;
            font-size: 1rem;
            font-weight: 600;
        }

        .roster-section.home h3 { color: var(--home); }
        .roster-section.away h3 { color: var(--away); }

        .roster-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 16px;
        }

        .player-row {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            margin-bottom: 6px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            transition: background 0.2s;
        }

        .player-row:hover {
            background: rgba(0, 0, 0, 0.5);
        }

        .player-number {
            font-weight: 700;
            min-width: 40px;
        }

        .player-name {
            flex: 1;
        }

        .player-pos {
            color: var(--text-dim);
            font-size: 0.8rem;
            min-width: 30px;
        }

        .player-stats {
            display: flex;
            gap: 8px;
            font-size: 0.75rem;
        }

        .player-stats .goals { color: var(--success); }
        .player-stats .assists { color: var(--warning); }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--text-dim);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Info boxes */
        .info-box {
            margin-top: 12px;
            padding: 12px 16px;
            background: rgba(0, 212, 255, 0.05);
            border: 1px solid rgba(0, 212, 255, 0.1);
            border-radius: 8px;
        }

        .info-box h4 {
            color: var(--primary);
            font-size: 0.85rem;
            margin-bottom: 8px;
        }

        .info-box ul {
            list-style: none;
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .info-box li {
            padding: 2px 0;
        }

        .info-box code {
            color: var(--primary);
            background: rgba(0, 0, 0, 0.3);
            padding: 1px 4px;
            border-radius: 3px;
        }

        /* Mini SLAP icons for cards */
        .card-icon {
            width: 20px;
            height: 20px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <!-- SLAP Watermark Overlay -->
    <img src="/static/img/SLAP_icon.webp" alt="" class="slap-watermark">

    <!-- Live Connection Indicator -->
    <div class="live-indicator" id="liveIndicator">
        <span class="dot"></span>
        <span class="status-text" id="connectionStatus">Connecting...</span>
    </div>

    <div class="header">
        <div class="header-content">
            <img src="/static/img/SLAP_icon.webp" alt="SLAP" class="header-logo">
            <h1>SLAP</h1>
            <p class="subtitle">Scoreboard Live Automation Platform</p>
        </div>
    </div>

    <div class="container">
        <!-- Scorebug Display -->
        <div class="card preview-container">
            <h2><img src="/static/img/SLAP_icon.webp" class="card-icon" alt=""> Scorebug</h2>
            <div class="preview-frame">
                <iframe id="scorebugPreview" src="/scorebug"></iframe>
            </div>
        </div>

        <!-- Score Display -->
        <div class="card">
            <h2>Current Score</h2>
            <div class="score-display">
                <div class="team">
                    <div class="team-name" id="homeTeamNameDisplay">HOME</div>
                    <div class="team-score home" id="homeScore">0</div>
                </div>
                <div class="vs">vs</div>
                <div class="team">
                    <div class="team-name" id="awayTeamNameDisplay">AWAY</div>
                    <div class="team-score away" id="awayScore">0</div>
                </div>
            </div>
            <div class="game-info">
                <div class="info-item">
                    <div class="info-label">Period</div>
                    <div class="info-value" id="period">1st</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Clock</div>
                    <div class="info-value" id="clock">20:00</div>
                </div>
            </div>
        </div>

        <!-- Simulator Controls (hidden unless enabled via slap -simulation:enable) -->
        <div class="card" id="simulatorCard" style="display: none;">
            <h2>Simulator</h2>
            <div class="controls">
                <button class="btn btn-success" onclick="startSimulator()">Start</button>
                <button class="btn btn-danger" onclick="stopSimulator()">Stop</button>
                <button class="btn btn-warning" onclick="resetSimulator()">Reset</button>
            </div>
            <div class="status-bar" style="margin-top: 16px;">
                <div class="status-item">
                    <div class="status-dot" id="simStatus"></div>
                    <span class="status-label">Simulator</span>
                </div>
            </div>
        </div>

        <!-- Goal Controls -->
        <div class="card">
            <h2>Goals</h2>
            <div class="controls">
                <button class="btn btn-home" onclick="triggerGoal('HOME')">Home Goal</button>
                <button class="btn btn-away" onclick="triggerGoal('AWAY')">Away Goal</button>
            </div>
        </div>

        <!-- Score Adjustments -->
        <div class="card">
            <h2>Manual Score</h2>
            <div class="controls">
                <div class="btn-group">
                    <button class="btn btn-sm btn-home" onclick="adjustScore('home', -1)">-</button>
                    <span style="padding: 8px 16px; color: var(--home); font-weight: 600;">Home</span>
                    <button class="btn btn-sm btn-home" onclick="adjustScore('home', 1)">+</button>
                </div>
                <div class="btn-group">
                    <button class="btn btn-sm btn-away" onclick="adjustScore('away', -1)">-</button>
                    <span style="padding: 8px 16px; color: var(--away); font-weight: 600;">Away</span>
                    <button class="btn btn-sm btn-away" onclick="adjustScore('away', 1)">+</button>
                </div>
            </div>
        </div>

        <!-- Period/Clock Controls -->
        <div class="card">
            <h2>Clock Controls</h2>
            <div class="input-group">
                <label>Period:</label>
                <select id="periodSelect" onchange="updatePeriod()">
                    <option value="1">1st</option>
                    <option value="2">2nd</option>
                    <option value="3">3rd</option>
                    <option value="OT">OT</option>
                </select>
            </div>
            <div class="input-group">
                <label>Clock:</label>
                <input type="text" id="clockInput" value="20:00" placeholder="MM:SS" style="width: 100px;">
                <button class="btn btn-sm btn-primary" onclick="updateClock()">Set</button>
            </div>
        </div>

        <!-- Penalties -->
        <div class="card">
            <h2>Penalties</h2>
            <div class="penalties">
                <div class="penalty-box">
                    <h3>Home</h3>
                    <div class="penalty-list home" id="homePenalties">None</div>
                </div>
                <div class="penalty-box">
                    <h3>Away</h3>
                    <div class="penalty-list away" id="awayPenalties">None</div>
                </div>
            </div>
            <div class="controls" style="margin-top: 16px; justify-content: center;">
                <button class="btn btn-sm btn-home" onclick="addPenalty('HOME', 120)">Home 2min</button>
                <button class="btn btn-sm btn-home" onclick="addPenalty('HOME', 300)">Home 5min</button>
                <button class="btn btn-sm btn-away" onclick="addPenalty('AWAY', 120)">Away 2min</button>
                <button class="btn btn-sm btn-away" onclick="addPenalty('AWAY', 300)">Away 5min</button>
            </div>
        </div>

        <!-- Bug Visibility -->
        <div class="card">
            <h2>Scorebug Display</h2>
            <div class="controls">
                <button class="btn btn-success" onclick="showBug()">Show</button>
                <button class="btn btn-danger" onclick="hideBug()">Hide</button>
            </div>
            <div class="status-bar" style="margin-top: 16px;">
                <div class="status-item">
                    <div class="status-dot" id="bugStatus"></div>
                    <span class="status-label">Visible</span>
                </div>
            </div>
        </div>

        <!-- Connection Status -->
        <div class="card">
            <h2>Connection Status</h2>
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-dot" id="serialStatus"></div>
                    <span class="status-label">Serial</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="casparStatus"></div>
                    <span class="status-label">CasparCG</span>
                </div>
                <div class="status-item">
                    <div class="status-dot connected" id="wsStatus"></div>
                    <span class="status-label">WebSocket</span>
                </div>
            </div>
        </div>

        <!-- CasparCG Server Control -->
        <div class="card">
            <h2>CasparCG Server</h2>
            <div class="status-bar" style="margin-bottom: 16px;">
                <div class="status-item">
                    <div class="status-dot" id="casparInstalled"></div>
                    <span class="status-label">Installed</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="casparRunning"></div>
                    <span class="status-label">Running</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="casparAmcp"></div>
                    <span class="status-label">AMCP</span>
                </div>
            </div>
            <div class="controls">
                <button class="btn btn-success" onclick="casparStart()" id="btnCasparStart">Start</button>
                <button class="btn btn-danger" onclick="casparStop()" id="btnCasparStop">Stop</button>
                <button class="btn btn-primary" onclick="casparConnect()" id="btnCasparConnect">Connect</button>
                <button class="btn btn-secondary" onclick="casparRefresh()">Refresh</button>
            </div>
            <div id="casparInfo" style="margin-top: 12px; font-size: 0.8rem; color: var(--text-dim);"></div>
        </div>

        <!-- OBS Studio Control -->
        <div class="card">
            <h2>OBS Studio</h2>
            <div class="status-bar" style="margin-bottom: 16px;">
                <div class="status-item">
                    <div class="status-dot" id="obsInstalled"></div>
                    <span class="status-label">Installed</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="obsRunning"></div>
                    <span class="status-label">Running</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="obsWebsocket"></div>
                    <span class="status-label">WebSocket</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="obsConnected"></div>
                    <span class="status-label">Connected</span>
                </div>
            </div>
            <div class="controls">
                <button class="btn btn-success" onclick="obsStart()" id="btnObsStart">Start</button>
                <button class="btn btn-danger" onclick="obsStop()" id="btnObsStop">Stop</button>
                <button class="btn btn-primary" onclick="obsConnect()" id="btnObsConnect">Connect</button>
                <button class="btn btn-secondary" onclick="obsRefresh()">Refresh</button>
            </div>
            <div id="obsInfo" style="margin-top: 12px; font-size: 0.8rem; color: var(--text-dim);"></div>
        </div>

        <!-- OBS Scorebug Setup -->
        <div class="card" id="obsScorebuCard" style="display: none;">
            <h2>OBS Scorebug Overlay</h2>
            <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 16px;">
                Add the SLAP scorebug as a browser source in your current OBS scene.
            </p>
            <div class="controls">
                <button class="btn btn-primary" onclick="obsSetupScoreBug()">Add to Scene</button>
                <button class="btn btn-success" onclick="obsShowScoreBug()">Show</button>
                <button class="btn btn-danger" onclick="obsHideScoreBug()">Hide</button>
                <button class="btn btn-secondary" onclick="obsRefreshScoreBug()">Refresh</button>
            </div>
            <div id="obsSceneInfo" style="margin-top: 12px; font-size: 0.8rem; color: var(--text-dim);"></div>
        </div>

        <!-- Serial Port Configuration -->
        <div class="card">
            <h2>Serial Port (MP-70)</h2>
            <div class="status-bar" style="margin-bottom: 16px;">
                <div class="status-item">
                    <div class="status-dot" id="serialConnected"></div>
                    <span class="status-label">Connected</span>
                </div>
                <div class="status-item" id="simModeStatus" style="display: none;">
                    <div class="status-dot" id="serialSimMode"></div>
                    <span class="status-label">Sim Mode</span>
                </div>
            </div>
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 6px; color: var(--text-muted); font-size: 0.85rem;">Serial Port:</label>
                <select id="serialPortSelect" style="width: 100%;">
                    <option value="">-- Select Port --</option>
                </select>
            </div>
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 6px; color: var(--text-muted); font-size: 0.85rem;">Baud Rate:</label>
                <select id="serialBaudSelect" style="width: 100%;">
                    <option value="9600" selected>9600</option>
                    <option value="19200">19200</option>
                    <option value="38400">38400</option>
                    <option value="57600">57600</option>
                    <option value="115200">115200</option>
                </select>
            </div>
            <div class="controls">
                <button class="btn btn-primary" onclick="serialApplyConfig()">Apply</button>
                <button class="btn btn-secondary" onclick="serialRefreshPorts()">Refresh</button>
                <button class="btn btn-success" id="btnSerialConnect" onclick="serialConnect()">Connect</button>
                <button class="btn btn-danger" id="btnSerialDisconnect" onclick="serialDisconnect()">Disconnect</button>
                <button class="btn btn-warning" id="btnToggleSim" onclick="toggleSimMode()" style="display: none;">Toggle Sim</button>
            </div>
            <div id="serialInfo" style="margin-top: 12px; font-size: 0.8rem; color: var(--text-dim);"></div>

            <!-- Verbose Serial Data Display -->
            <details style="margin-top: 16px;">
                <summary style="cursor: pointer; color: var(--primary); font-weight: 600; margin-bottom: 10px;">Verbose Serial Data</summary>
                <div id="serialVerbose" style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 12px; font-family: monospace; font-size: 0.75rem;">
                    <!-- Recording Controls -->
                    <div style="margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <button id="btnRecordStart" class="btn btn-sm btn-success" onclick="startRecording()">Start Recording</button>
                            <button id="btnRecordStop" class="btn btn-sm btn-danger" onclick="stopRecording()" style="display: none;">Stop Recording</button>
                            <div id="recordingIndicator" style="display: none; color: var(--danger); animation: pulse 1s infinite;">
                                ‚óè RECORDING
                            </div>
                        </div>
                        <div id="recordingInfo" style="color: var(--text-muted); font-size: 0.7rem;"></div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-bottom: 12px;">
                        <div>
                            <span style="color: var(--text-muted);">Total Packets:</span>
                            <span id="serialStatTotal" style="color: var(--success);">0</span>
                        </div>
                        <div>
                            <span style="color: var(--text-muted);">Valid:</span>
                            <span id="serialStatValid" style="color: var(--success);">0</span>
                        </div>
                        <div>
                            <span style="color: var(--text-muted);">Clock (C):</span>
                            <span id="serialStatClock" style="color: var(--primary);">0</span>
                        </div>
                        <div>
                            <span style="color: var(--text-muted);">Score (H):</span>
                            <span id="serialStatScore" style="color: var(--primary);">0</span>
                        </div>
                        <div>
                            <span style="color: var(--text-muted);">Invalid:</span>
                            <span id="serialStatInvalid" style="color: var(--danger);">0</span>
                        </div>
                        <div>
                            <span style="color: var(--text-muted);">Bytes:</span>
                            <span id="serialStatBytes" style="color: var(--text);">0</span>
                        </div>
                    </div>
                    <div style="margin-bottom: 8px;">
                        <span style="color: var(--text-muted);">Last Packet Type:</span>
                        <span id="serialLastType" style="color: var(--warning);">-</span>
                        <span style="color: var(--text-muted); margin-left: 12px;">Time:</span>
                        <span id="serialLastTime" style="color: var(--text-dim);">-</span>
                    </div>
                    <div style="margin-bottom: 4px; color: var(--text-muted);">Last Raw Data (Hex):</div>
                    <div id="serialRawHex" style="background: rgba(0,0,0,0.4); padding: 8px; border-radius: 4px; word-break: break-all; color: var(--primary); min-height: 40px;">-</div>
                    <div style="margin: 8px 0 4px; color: var(--text-muted);">Last Raw Data (ASCII):</div>
                    <div id="serialRawAscii" style="background: rgba(0,0,0,0.4); padding: 8px; border-radius: 4px; word-break: break-all; color: var(--success); min-height: 40px;">-</div>
                </div>
            </details>
        </div>

        <!-- System Status & Errors -->
        <div class="card">
            <h2>System</h2>
            <div class="status-bar" style="margin-bottom: 16px;">
                <div class="status-item">
                    <span style="color: var(--text-muted);">Version:</span>
                    <span id="sysVersion" style="color: var(--primary);">-</span>
                </div>
                <div class="status-item">
                    <span style="color: var(--text-muted);">Memory:</span>
                    <span id="sysMemory" style="color: var(--text);">-</span>
                </div>
            </div>
            <div class="controls" style="margin-bottom: 16px;">
                <button class="btn btn-primary" onclick="systemUpdate()">Update from GitHub</button>
                <button class="btn btn-secondary" onclick="refreshSystemStatus()">Refresh</button>
            </div>
            <div id="systemUpdateStatus" style="margin-bottom: 12px; font-size: 0.85rem; color: var(--text-muted);"></div>

            <!-- Error Log -->
            <details>
                <summary style="cursor: pointer; color: var(--danger); font-weight: 600; margin-bottom: 10px;">Error Log</summary>
                <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 12px;">
                    <div class="controls" style="margin-bottom: 12px;">
                        <button class="btn btn-sm btn-secondary" onclick="refreshErrorLog()">Refresh</button>
                        <button class="btn btn-sm btn-danger" onclick="clearErrorLog()">Clear Log</button>
                    </div>
                    <div id="errorLogContent" style="font-family: monospace; font-size: 0.7rem; max-height: 300px; overflow-y: auto; background: rgba(0,0,0,0.4); padding: 8px; border-radius: 4px; color: var(--danger);">
                        No errors logged.
                    </div>
                </div>
            </details>
        </div>

        <!-- Broadcast Overlays Control -->
        <div class="card full-width">
            <h2><img src="/static/img/SLAP_icon.webp" class="card-icon" alt=""> Broadcast Overlays</h2>
            <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 20px;">
                Trigger NHL-style broadcast graphics. Each overlay has a unique URL for CasparCG or OBS browser sources.
            </p>

            <div class="overlay-grid">
                <!-- Goal Splash -->
                <div class="overlay-card" style="border-color: #ffd700;">
                    <h3 style="color: #ffd700;">Goal Splash</h3>
                    <div class="controls" style="margin-bottom: 10px;">
                        <button class="btn btn-sm btn-home" onclick="triggerGoalSplash('home')">Home</button>
                        <button class="btn btn-sm btn-away" onclick="triggerGoalSplash('away')">Away</button>
                        <button class="btn btn-sm btn-secondary" onclick="hideOverlay('goal')">Hide</button>
                    </div>
                    <code>/overlay/goal</code>
                </div>

                <!-- Replay Bug -->
                <div class="overlay-card" style="border-color: var(--danger);">
                    <h3 style="color: var(--danger);">Replay Bug</h3>
                    <div class="controls" style="margin-bottom: 10px;">
                        <button class="btn btn-sm btn-danger" onclick="showReplay()">REPLAY</button>
                        <button class="btn btn-sm btn-secondary" onclick="hideOverlay('replay')">Hide</button>
                    </div>
                    <code>/overlay/replay</code>
                </div>

                <!-- Player Card -->
                <div class="overlay-card" style="border-color: var(--primary);">
                    <h3 style="color: var(--primary);">Player Card</h3>
                    <div style="margin-bottom: 10px; display: flex; gap: 6px;">
                        <input type="text" id="playerNum" placeholder="#" style="width: 50px;" maxlength="3">
                        <input type="text" id="playerName" placeholder="Name" style="flex: 1;">
                    </div>
                    <div class="controls" style="margin-bottom: 10px;">
                        <button class="btn btn-sm btn-home" onclick="showPlayerCard('home')">Home</button>
                        <button class="btn btn-sm btn-away" onclick="showPlayerCard('away')">Away</button>
                        <button class="btn btn-sm btn-secondary" onclick="hideOverlay('player')">Hide</button>
                    </div>
                    <code>/overlay/player</code>
                </div>

                <!-- Goalie Stats -->
                <div class="overlay-card" style="border-color: var(--success);">
                    <h3 style="color: var(--success);">Goalie Stats</h3>
                    <div style="margin-bottom: 10px; display: flex; gap: 6px;">
                        <input type="text" id="goalieNum" placeholder="#" style="width: 50px;" maxlength="3">
                        <input type="number" id="goalieSaves" placeholder="Saves" style="width: 70px;">
                        <input type="number" id="goalieShots" placeholder="Shots" style="width: 70px;">
                    </div>
                    <div class="controls" style="margin-bottom: 10px;">
                        <button class="btn btn-sm btn-success" onclick="showGoalieStats()">Show</button>
                        <button class="btn btn-sm btn-secondary" onclick="hideOverlay('goalie')">Hide</button>
                    </div>
                    <code>/overlay/goalie</code>
                </div>

                <!-- Period Summary -->
                <div class="overlay-card" style="border-color: #9c27b0;">
                    <h3 style="color: #9c27b0;">Period Summary</h3>
                    <div class="controls" style="margin-bottom: 10px;">
                        <button class="btn btn-sm btn-primary" onclick="showPeriodSummary()">Show</button>
                        <button class="btn btn-sm btn-secondary" onclick="hideOverlay('period')">Hide</button>
                    </div>
                    <code>/overlay/period</code>
                </div>

                <!-- Game Intro -->
                <div class="overlay-card" style="border-color: var(--warning);">
                    <h3 style="color: var(--warning);">Game Intro</h3>
                    <div class="controls" style="margin-bottom: 10px;">
                        <button class="btn btn-sm btn-warning" onclick="showGameIntro()">Matchup</button>
                        <button class="btn btn-sm btn-secondary" onclick="hideOverlay('intro')">Hide</button>
                    </div>
                    <code>/overlay/intro</code>
                </div>

                <!-- Three Stars -->
                <div class="overlay-card" style="border-color: #c0c0c0;">
                    <h3 style="color: #c0c0c0;">Three Stars</h3>
                    <div class="controls" style="margin-bottom: 10px;">
                        <button class="btn btn-sm" style="background: linear-gradient(135deg, #ffd700, #daa520); color: #000;" onclick="showThreeStars()">Stars</button>
                        <button class="btn btn-sm btn-secondary" onclick="hideOverlay('stars')">Hide</button>
                    </div>
                    <code>/overlay/stars</code>
                </div>

                <!-- Power Play -->
                <div class="overlay-card" style="border-color: #ffeb3b;">
                    <h3 style="color: #ffeb3b;">Power Play</h3>
                    <div class="controls" style="margin-bottom: 10px;">
                        <button class="btn btn-sm btn-home" onclick="showPowerPlay('home')">Home PP</button>
                        <button class="btn btn-sm btn-away" onclick="showPowerPlay('away')">Away PP</button>
                        <button class="btn btn-sm btn-secondary" onclick="hideOverlay('powerplay')">Hide</button>
                    </div>
                    <code>/overlay/powerplay</code>
                </div>

                <!-- Shot Counter -->
                <div class="overlay-card" style="border-color: #4caf50;">
                    <h3 style="color: #4caf50;">Shot Counter</h3>
                    <div style="margin-bottom: 10px; display: flex; gap: 6px;">
                        <input type="number" id="homeShots" placeholder="Home" style="width: 70px;" value="0">
                        <input type="number" id="awayShots" placeholder="Away" style="width: 70px;" value="0">
                    </div>
                    <div class="controls" style="margin-bottom: 10px;">
                        <button class="btn btn-sm btn-success" onclick="updateShotCounter()">Update</button>
                    </div>
                    <code>/overlay/shots</code>
                </div>

                <!-- Penalty Box -->
                <div class="overlay-card" style="border-color: #f44336;">
                    <h3 style="color: #f44336;">Penalty Details</h3>
                    <div class="controls" style="margin-bottom: 10px;">
                        <button class="btn btn-sm btn-home" onclick="addPenaltyOverlay('home')">Home</button>
                        <button class="btn btn-sm btn-away" onclick="addPenaltyOverlay('away')">Away</button>
                    </div>
                    <code>/overlay/penalty</code>
                </div>

                <!-- Ticker -->
                <div class="overlay-card" style="border-color: #2196f3;">
                    <h3 style="color: #2196f3;">Scores Ticker</h3>
                    <div class="controls" style="margin-bottom: 10px;">
                        <button class="btn btn-sm btn-primary" onclick="showTicker()">Demo</button>
                        <button class="btn btn-sm btn-secondary" onclick="hideOverlay('ticker')">Hide</button>
                    </div>
                    <code>/overlay/ticker</code>
                </div>
            </div>

            <div class="info-box">
                <h4>Overlay URLs</h4>
                <p style="color: var(--text-muted); font-size: 0.8rem; margin-bottom: 8px;">
                    Use these URLs in CasparCG or OBS Browser Sources:
                </p>
                <ul>
                    <li><code>/overlay</code> - Main scorebug</li>
                    <li><code>/overlay/goal</code> - Goal celebration</li>
                    <li><code>/overlay/player</code> - Player card</li>
                    <li><code>/overlay/goalie</code> - Goalie stats</li>
                    <li><code>/overlay/period</code> - Period summary</li>
                    <li><code>/overlay/intro</code> - Game intro</li>
                    <li><code>/overlay/stars</code> - Three stars</li>
                    <li><code>/overlay/powerplay</code> - Power play</li>
                    <li><code>/overlay/shots</code> - Shot counter</li>
                    <li><code>/overlay/penalty</code> - Penalty details</li>
                    <li><code>/overlay/replay</code> - Replay bug</li>
                    <li><code>/overlay/ticker</code> - Scores ticker</li>
                </ul>
            </div>
        </div>

        <!-- Team Customization -->
        <div class="card">
            <h2>Team Customization</h2>
            <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 16px;">
                Customize team names, colors, and logos.
            </p>

            <!-- Home Team -->
            <div class="roster-section home" style="margin-bottom: 16px;">
                <h3>Home Team</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="display: block; margin-bottom: 4px; font-size: 0.8rem; color: var(--text-dim);">Name:</label>
                        <input type="text" id="homeTeamName" placeholder="HOME" style="width: 100%;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 4px; font-size: 0.8rem; color: var(--text-dim);">Short:</label>
                        <input type="text" id="homeTeamShort" placeholder="HOM" maxlength="4" style="width: 100%;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 4px; font-size: 0.8rem; color: var(--text-dim);">Primary:</label>
                        <input type="color" id="homeTeamColor" value="#1b6eb8" style="width: 100%; height: 38px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 4px; font-size: 0.8rem; color: var(--text-dim);">Secondary:</label>
                        <input type="color" id="homeTeamColor2" value="#00529c" style="width: 100%; height: 38px;">
                    </div>
                    <div style="grid-column: span 2;">
                        <label style="display: block; margin-bottom: 4px; font-size: 0.8rem; color: var(--text-dim);">Logo:</label>
                        <select id="homeTeamLogo" style="width: 100%;">
                            <option value="home.png">home.png</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Away Team -->
            <div class="roster-section away" style="margin-bottom: 16px;">
                <h3>Away Team</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="display: block; margin-bottom: 4px; font-size: 0.8rem; color: var(--text-dim);">Name:</label>
                        <input type="text" id="awayTeamNameInput" placeholder="AWAY" style="width: 100%;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 4px; font-size: 0.8rem; color: var(--text-dim);">Short:</label>
                        <input type="text" id="awayTeamShort" placeholder="AWY" maxlength="4" style="width: 100%;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 4px; font-size: 0.8rem; color: var(--text-dim);">Primary:</label>
                        <input type="color" id="awayTeamColor" value="#aa0000" style="width: 100%; height: 38px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 4px; font-size: 0.8rem; color: var(--text-dim);">Secondary:</label>
                        <input type="color" id="awayTeamColor2" value="#780000" style="width: 100%; height: 38px;">
                    </div>
                    <div style="grid-column: span 2;">
                        <label style="display: block; margin-bottom: 4px; font-size: 0.8rem; color: var(--text-dim);">Logo:</label>
                        <select id="awayTeamLogo" style="width: 100%;">
                            <option value="away.png">away.png</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Logo Upload -->
            <div style="background: var(--bg-input); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-size: 0.85rem; color: var(--text-muted);">Upload Logo:</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="file" id="logoUpload" accept=".png,.jpg,.jpeg,.svg,.gif,.webp" style="flex: 1;">
                    <button class="btn btn-sm btn-primary" onclick="uploadLogo()">Upload</button>
                </div>
                <div id="uploadStatus" style="margin-top: 8px; font-size: 0.8rem; color: var(--text-dim);"></div>
            </div>

            <div class="controls">
                <button class="btn btn-success" onclick="applyTeamConfig()">Apply</button>
                <button class="btn btn-secondary" onclick="refreshTeamConfig()">Refresh</button>
                <button class="btn btn-warning" onclick="resetTeamConfig()">Reset</button>
            </div>
            <div id="teamConfigStatus" style="margin-top: 12px; font-size: 0.8rem; color: var(--text-dim);"></div>
        </div>

        <!-- Roster Manager -->
        <div class="card full-width">
            <h2>Team Rosters</h2>
            <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 20px;">
                Manage player names and numbers. Click a player to show their card on broadcast.
            </p>

            <div class="roster-container">
                <!-- Home Roster -->
                <div class="roster-section home">
                    <h3>Home Roster</h3>
                    <div class="roster-list" id="homeRosterList"></div>
                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                        <input type="text" id="homePlayerNum" placeholder="#" style="width: 50px;" maxlength="3">
                        <input type="text" id="homePlayerName" placeholder="Name" style="flex: 1; min-width: 100px;">
                        <select id="homePlayerPos" style="width: 60px;">
                            <option value="G">G</option>
                            <option value="D">D</option>
                            <option value="C">C</option>
                            <option value="LW">LW</option>
                            <option value="RW">RW</option>
                            <option value="F" selected>F</option>
                        </select>
                        <button class="btn btn-sm btn-home" onclick="addRosterPlayer('home')">Add</button>
                    </div>
                </div>

                <!-- Away Roster -->
                <div class="roster-section away">
                    <h3>Away Roster</h3>
                    <div class="roster-list" id="awayRosterList"></div>
                    <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                        <input type="text" id="awayPlayerNum" placeholder="#" style="width: 50px;" maxlength="3">
                        <input type="text" id="awayPlayerName" placeholder="Name" style="flex: 1; min-width: 100px;">
                        <select id="awayPlayerPos" style="width: 60px;">
                            <option value="G">G</option>
                            <option value="D">D</option>
                            <option value="C">C</option>
                            <option value="LW">LW</option>
                            <option value="RW">RW</option>
                            <option value="F" selected>F</option>
                        </select>
                        <button class="btn btn-sm btn-away" onclick="addRosterPlayer('away')">Add</button>
                    </div>
                </div>
            </div>

            <div class="controls" style="margin-top: 20px; justify-content: center;">
                <button class="btn btn-secondary" onclick="refreshRosters()">Refresh</button>
                <button class="btn btn-warning" onclick="resetRosterStats()">Reset Stats</button>
            </div>
        </div>

        <!-- Game History & Statistics -->
        <div class="card full-width">
            <h2>Game History & Statistics</h2>
            <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 20px;">
                Track game history, player stats, and scoring leaders.
            </p>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- Game Management -->
                <div style="background: var(--bg-input); padding: 16px; border-radius: 12px;">
                    <h3 style="color: var(--primary); margin-bottom: 16px; font-size: 1rem;">Current Game</h3>
                    <div id="currentGameInfo" style="margin-bottom: 16px; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                        <p style="color: var(--text-dim); text-align: center;">No active game</p>
                    </div>
                    <div class="controls" style="gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-sm btn-primary" onclick="startNewGame()">New Game</button>
                        <button class="btn btn-sm btn-success" onclick="endCurrentGame('final')">End</button>
                        <button class="btn btn-sm btn-warning" onclick="endCurrentGame('cancelled')">Cancel</button>
                    </div>
                </div>

                <!-- Stat Leaders -->
                <div style="background: var(--bg-input); padding: 16px; border-radius: 12px;">
                    <h3 style="color: var(--primary); margin-bottom: 16px; font-size: 1rem;">Season Leaders</h3>
                    <div id="statLeaders" style="max-height: 200px; overflow-y: auto;">
                        <p style="color: var(--text-dim); text-align: center;">No stats yet</p>
                    </div>
                    <div class="controls" style="margin-top: 12px; gap: 8px;">
                        <button class="btn btn-sm btn-secondary" onclick="loadStatLeaders('points')">Points</button>
                        <button class="btn btn-sm btn-secondary" onclick="loadStatLeaders('goals')">Goals</button>
                        <button class="btn btn-sm btn-secondary" onclick="loadStatLeaders('assists')">Assists</button>
                    </div>
                </div>
            </div>

            <!-- Recent Games -->
            <div style="margin-top: 20px;">
                <h3 style="color: var(--primary); margin-bottom: 16px; font-size: 1rem;">Recent Games</h3>
                <div id="recentGames" style="display: grid; gap: 10px; max-height: 300px; overflow-y: auto;">
                    <p style="color: var(--text-dim); text-align: center;">No games recorded</p>
                </div>
            </div>

            <div class="controls" style="margin-top: 20px; justify-content: center;">
                <button class="btn btn-secondary" onclick="refreshGameHistory()">Refresh History</button>
            </div>
        </div>
    </div>

    <script src="/static/js/socket.io.min.js"></script>
    <script>
        // WebSocket connection
        const socket = io();

        // State
        let currentState = {
            game: { home: 0, away: 0, period: "1", clock: "20:00", home_penalties: [], away_penalties: [] },
            bug_visible: true,
            simulator_running: false,
            serial_connected: false,
            caspar_connected: false
        };

        // Socket events
        socket.on('connect', () => {
            console.log('Connected to SLAP server');
            document.getElementById('wsStatus').classList.add('connected');
            document.getElementById('liveIndicator').classList.add('connected');
            document.getElementById('connectionStatus').textContent = 'Live';
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from SLAP server');
            document.getElementById('wsStatus').classList.remove('connected');
            document.getElementById('liveIndicator').classList.remove('connected');
            document.getElementById('connectionStatus').textContent = 'Disconnected';
        });

        socket.on('state_update', (state) => {
            currentState = state;
            updateUI();
        });

        // Update UI from state
        function updateUI() {
            const game = currentState.game;

            // Scores
            document.getElementById('homeScore').textContent = game.home;
            document.getElementById('awayScore').textContent = game.away;

            // Period
            let periodText = game.period;
            if (periodText === "1") periodText = "1st";
            else if (periodText === "2") periodText = "2nd";
            else if (periodText === "3") periodText = "3rd";
            document.getElementById('period').textContent = periodText;
            document.getElementById('periodSelect').value = game.period;

            // Clock
            document.getElementById('clock').textContent = game.clock;
            document.getElementById('clockInput').value = game.clock;

            // Penalties
            const homePens = game.home_penalties || [];
            const awayPens = game.away_penalties || [];
            document.getElementById('homePenalties').textContent =
                homePens.length ? homePens.map(formatPenalty).join(', ') : 'None';
            document.getElementById('awayPenalties').textContent =
                awayPens.length ? awayPens.map(formatPenalty).join(', ') : 'None';

            // Status indicators
            updateStatus('simStatus', currentState.simulator_running);
            updateStatus('bugStatus', currentState.bug_visible);
            updateStatus('serialStatus', currentState.serial_connected);
            updateStatus('casparStatus', currentState.caspar_connected);

            // Update scorebug display
            updateScorebug();
        }

        function formatPenalty(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        function updateStatus(id, connected) {
            const el = document.getElementById(id);
            if (el) {
                if (connected) {
                    el.classList.add('connected');
                } else {
                    el.classList.remove('connected');
                }
            }
        }

        function updateScorebug() {
            const iframe = document.getElementById('scorebugPreview');
            if (iframe.contentWindow && iframe.contentWindow.updateFromParent) {
                iframe.contentWindow.updateFromParent(currentState.game);
            }
        }

        // API calls
        async function api(endpoint, method = 'GET', data = null) {
            const options = { method, headers: { 'Content-Type': 'application/json' } };
            if (data) options.body = JSON.stringify(data);
            const response = await fetch(`/api${endpoint}`, options);
            return response.json();
        }

        // Control functions
        function startSimulator() { api('/simulator/start', 'POST'); }
        function stopSimulator() { api('/simulator/stop', 'POST'); }
        function resetSimulator() { api('/simulator/reset', 'POST'); }

        function triggerGoal(side) { api('/goal', 'POST', { side }); }

        function adjustScore(team, delta) {
            const newScore = Math.max(0, currentState.game[team === 'home' ? 'home' : 'away'] + delta);
            const data = team === 'home' ? { home: newScore } : { away: newScore };
            api('/state', 'POST', data);
        }

        function updatePeriod() {
            const period = document.getElementById('periodSelect').value;
            api('/state', 'POST', { period });
        }

        function updateClock() {
            const clock = document.getElementById('clockInput').value;
            api('/state', 'POST', { clock });
        }

        function addPenalty(side, duration) {
            api('/penalty', 'POST', { side, duration });
        }

        function showBug() { api('/bug/show', 'POST'); }
        function hideBug() { api('/bug/hide', 'POST'); }

        // Initial state fetch
        api('/state').then(state => {
            currentState = state;
            updateUI();
        });

        // CasparCG Server Control
        let casparState = { installed: false, running: false, amcp_listening: false, connected: false, binary: null };

        async function casparRefresh() {
            try {
                const status = await api('/caspar/status');
                casparState = status;
                updateCasparUI();
            } catch (e) {
                console.error('Failed to get CasparCG status:', e);
            }
        }

        function updateCasparUI() {
            updateStatus('casparInstalled', casparState.installed);
            updateStatus('casparRunning', casparState.running);
            updateStatus('casparAmcp', casparState.amcp_listening);

            const info = document.getElementById('casparInfo');
            if (casparState.installed) {
                let text = `Binary: ${casparState.binary || 'found'}`;
                if (casparState.running && casparState.pid) text += ` | PID: ${casparState.pid}`;
                if (casparState.amcp_listening) text += ' | AMCP: port 5250';
                info.textContent = text;
            } else {
                info.innerHTML = 'Not installed. Run: <code>./deploy.sh caspar-install</code>';
            }

            document.getElementById('btnCasparStart').disabled = !casparState.installed || casparState.running;
            document.getElementById('btnCasparStop').disabled = !casparState.running;
            document.getElementById('btnCasparConnect').disabled = !casparState.amcp_listening;
        }

        async function casparStart() {
            document.getElementById('btnCasparStart').disabled = true;
            try {
                await api('/caspar/start', 'POST');
                setTimeout(casparRefresh, 3000);
            } catch (e) {
                alert('Failed to start CasparCG: ' + e.message);
            }
        }

        async function casparStop() {
            document.getElementById('btnCasparStop').disabled = true;
            try {
                await api('/caspar/stop', 'POST');
                setTimeout(casparRefresh, 1000);
            } catch (e) {
                alert('Failed to stop CasparCG: ' + e.message);
            }
        }

        async function casparConnect() {
            document.getElementById('btnCasparConnect').disabled = true;
            try {
                const result = await api('/caspar/connect', 'POST');
                if (result.connected) updateStatus('casparStatus', true);
            } catch (e) {
                alert('Failed to connect to CasparCG');
            }
            casparRefresh();
        }

        casparRefresh();
        setInterval(casparRefresh, 10000);

        // OBS Studio Control
        let obsState = { installed: false, running: false, websocket_listening: false, connected: false };

        async function obsRefresh() {
            try {
                const status = await api('/obs/status');
                obsState = status;
                updateObsUI();
            } catch (e) {
                console.error('Failed to get OBS status:', e);
            }
        }

        function updateObsUI() {
            updateStatus('obsInstalled', obsState.installed);
            updateStatus('obsRunning', obsState.running);
            updateStatus('obsWebsocket', obsState.websocket_listening);
            updateStatus('obsConnected', obsState.connected);

            const info = document.getElementById('obsInfo');
            const scorebugCard = document.getElementById('obsScorebuCard');

            if (obsState.installed) {
                let text = `Binary: ${obsState.binary || 'found'}`;
                if (obsState.running && obsState.pid) text += ` | PID: ${obsState.pid}`;
                if (obsState.connected && obsState.current_scene) text += ` | Scene: ${obsState.current_scene}`;
                info.textContent = text;
            } else {
                info.innerHTML = 'Not installed. Download from <a href="https://obsproject.com/" target="_blank" style="color: var(--primary);">obsproject.com</a>';
            }

            scorebugCard.style.display = obsState.connected ? 'block' : 'none';

            document.getElementById('btnObsStart').disabled = !obsState.installed || obsState.running;
            document.getElementById('btnObsStop').disabled = !obsState.running;
            document.getElementById('btnObsConnect').disabled = !obsState.websocket_listening || obsState.connected;
        }

        async function obsStart() {
            document.getElementById('btnObsStart').disabled = true;
            try {
                await api('/obs/start', 'POST');
                setTimeout(obsRefresh, 3000);
            } catch (e) {
                alert('Failed to start OBS: ' + e.message);
            }
        }

        async function obsStop() {
            document.getElementById('btnObsStop').disabled = true;
            try {
                await api('/obs/stop', 'POST');
                setTimeout(obsRefresh, 1000);
            } catch (e) {
                alert('Failed to stop OBS: ' + e.message);
            }
        }

        async function obsConnect() {
            document.getElementById('btnObsConnect').disabled = true;
            try {
                const result = await api('/obs/connect', 'POST');
                if (result.connected) {
                    obsState.connected = true;
                    obsState.current_scene = result.current_scene;
                    updateObsUI();
                }
            } catch (e) {
                alert('Failed to connect to OBS WebSocket');
            }
            obsRefresh();
        }

        async function obsSetupScoreBug() {
            try {
                const result = await api('/obs/setup-scorebug', 'POST');
                if (result.status === 'ok') alert('Scorebug added: ' + result.source_name);
            } catch (e) {
                alert('Failed to add scorebug');
            }
        }

        async function obsShowScoreBug() { await api('/obs/scorebug/show', 'POST'); }
        async function obsHideScoreBug() { await api('/obs/scorebug/hide', 'POST'); }
        async function obsRefreshScoreBug() { await api('/obs/scorebug/refresh', 'POST'); }

        obsRefresh();
        setInterval(obsRefresh, 10000);

        // Serial Port Control
        let serialState = { connected: false, simulator_mode: false, configured_port: '', baudrate: 9600, ports: [] };

        async function serialRefreshPorts() {
            try {
                const ports = await api('/serial/ports');
                serialState.ports = ports.ports || [];
                const select = document.getElementById('serialPortSelect');
                select.innerHTML = '<option value="">-- Select Port --</option>';
                for (const port of serialState.ports) {
                    const opt = document.createElement('option');
                    opt.value = port.device;
                    opt.textContent = `${port.device} - ${port.description}`;
                    if (port.device === serialState.configured_port) opt.selected = true;
                    select.appendChild(opt);
                }
            } catch (e) {
                console.error('Failed to get serial ports:', e);
            }
        }

        async function serialRefreshStatus() {
            try {
                const status = await api('/serial/status');
                serialState = { ...serialState, ...status };
                updateSerialUI();
            } catch (e) {
                console.error('Failed to get serial status:', e);
            }
        }

        function updateSerialUI() {
            updateStatus('serialConnected', serialState.connected);

            // Only update sim mode status if simulation is both enabled AND visible
            const simActive = systemSettings.simulation_enabled && systemSettings.simulation_visible;
            if (simActive) {
                updateStatus('serialSimMode', serialState.simulator_mode);
            }

            const info = document.getElementById('serialInfo');

            // Only show simulation mode text if simulation is both enabled AND visible
            if (serialState.simulator_mode && simActive) {
                info.textContent = 'Running in SIMULATION mode';
                info.style.color = 'var(--warning)';
            } else if (serialState.connected) {
                info.textContent = `Connected: ${serialState.configured_port} @ ${serialState.baudrate}`;
                info.style.color = 'var(--success)';
            } else {
                info.textContent = `Not connected. Port: ${serialState.configured_port || 'none'}`;
                info.style.color = 'var(--text-muted)';
            }
            document.getElementById('serialBaudSelect').value = serialState.baudrate;
        }

        async function serialApplyConfig() {
            const port = document.getElementById('serialPortSelect').value;
            const baudrate = document.getElementById('serialBaudSelect').value;
            if (!port) { alert('Please select a serial port'); return; }
            try {
                await api('/serial/config', 'POST', { port, baudrate: parseInt(baudrate) });
                alert('Config saved. Restart SLAP to apply.');
            } catch (e) {
                alert('Failed to save configuration');
            }
        }

        async function serialConnect() {
            try {
                const result = await api('/serial/connect', 'POST');
                if (result.status === 'ok') {
                    alert(result.message || 'Serial port connected');
                    serialRefreshStatus();
                } else {
                    alert(result.error || 'Failed to connect');
                }
            } catch (e) {
                alert('Failed to connect: ' + (e.message || e));
            }
        }

        async function serialDisconnect() {
            try {
                const result = await api('/serial/disconnect', 'POST');
                if (result.status === 'ok') {
                    alert(result.message || 'Serial port released');
                    serialRefreshStatus();
                } else {
                    alert(result.error || 'Failed to disconnect');
                }
            } catch (e) {
                alert('Failed to disconnect: ' + (e.message || e));
            }
        }

        async function toggleSimMode() {
            // Only allow if simulation is both enabled AND visible
            if (!systemSettings.simulation_enabled || !systemSettings.simulation_visible) return;
            await api('/simulator/start', 'POST');
            serialRefreshStatus();
        }

        serialRefreshStatus();
        serialRefreshPorts();
        setInterval(serialRefreshStatus, 5000);

        // Verbose Serial Data
        async function refreshVerboseSerialData() {
            try {
                const data = await api('/system/serial/data');
                if (data.serial) {
                    const s = data.serial;
                    const stats = s.packet_stats || {};
                    document.getElementById('serialStatTotal').textContent = stats.total_received || 0;
                    document.getElementById('serialStatValid').textContent = stats.valid_packets || 0;
                    document.getElementById('serialStatClock').textContent = stats.clock_packets || 0;
                    document.getElementById('serialStatScore').textContent = stats.score_packets || 0;
                    document.getElementById('serialStatInvalid').textContent = stats.invalid_packets || 0;
                    document.getElementById('serialStatBytes').textContent = stats.bytes_received || 0;
                    document.getElementById('serialLastType').textContent = stats.last_packet_type || '-';
                    document.getElementById('serialLastTime').textContent = stats.last_packet_time ? new Date(stats.last_packet_time).toLocaleTimeString() : '-';
                    document.getElementById('serialRawHex').textContent = s.last_raw_data || '-';
                    document.getElementById('serialRawAscii').textContent = s.last_raw_ascii || '-';

                    // Update recording UI
                    updateRecordingUI(s.recording);
                }
            } catch (e) {
                console.error('Failed to get verbose serial data:', e);
            }
        }

        function updateRecordingUI(recording) {
            const btnStart = document.getElementById('btnRecordStart');
            const btnStop = document.getElementById('btnRecordStop');
            const indicator = document.getElementById('recordingIndicator');
            const info = document.getElementById('recordingInfo');

            if (recording && recording.recording) {
                btnStart.style.display = 'none';
                btnStop.style.display = 'inline-block';
                indicator.style.display = 'inline-block';
                info.textContent = `Recording to: ${recording.path} (${recording.bytes_recorded} bytes)`;
                info.style.color = 'var(--danger)';
            } else {
                btnStart.style.display = 'inline-block';
                btnStop.style.display = 'none';
                indicator.style.display = 'none';
                if (recording && recording.path && recording.bytes_recorded > 0) {
                    info.textContent = `Last recording: ${recording.path} (${recording.bytes_recorded} bytes)`;
                    info.style.color = 'var(--success)';
                } else {
                    info.textContent = '';
                }
            }
        }

        async function startRecording() {
            try {
                const result = await api('/system/serial/record/start', 'POST');
                if (result.status === 'ok') {
                    document.getElementById('recordingInfo').textContent = `Recording started: ${result.path}`;
                    refreshVerboseSerialData();
                } else {
                    alert('Failed to start recording: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Failed to start recording: ' + e.message);
            }
        }

        async function stopRecording() {
            try {
                const result = await api('/system/serial/record/stop', 'POST');
                if (result.status === 'ok' || result.status === 'stopped') {
                    document.getElementById('recordingInfo').textContent = `Recording saved: ${result.path} (${result.bytes_recorded} bytes)`;
                    document.getElementById('recordingInfo').style.color = 'var(--success)';
                    refreshVerboseSerialData();
                } else {
                    alert('No active recording');
                }
            } catch (e) {
                alert('Failed to stop recording: ' + e.message);
            }
        }

        // Refresh verbose data when details is opened
        document.querySelector('#serialVerbose')?.closest('details')?.addEventListener('toggle', (e) => {
            if (e.target.open) refreshVerboseSerialData();
        });
        setInterval(() => {
            const details = document.querySelector('#serialVerbose')?.closest('details');
            if (details && details.open) refreshVerboseSerialData();
        }, 2000);

        // System Status & Settings
        let systemSettings = {
            simulation_enabled: false,
            simulation_visible: false
        };

        async function refreshSystemStatus() {
            try {
                // Load both status and settings
                const [status, settingsResult] = await Promise.all([
                    api('/system/status'),
                    api('/system/settings')
                ]);

                if (status.slap) {
                    document.getElementById('sysVersion').textContent = status.slap.version || 'unknown';
                }
                if (status.system && status.system.memory_mb) {
                    document.getElementById('sysMemory').textContent = status.system.memory_mb.toFixed(1) + ' MB';
                }

                // Merge status.slap with settings for complete picture
                systemSettings = {
                    ...(status.slap || {}),
                    ...(settingsResult.settings || {})
                };

                // Show/hide simulator controls based on BOTH simulation_visible AND simulation_enabled
                const simEnabled = systemSettings.simulation_enabled === true;
                const simVisible = systemSettings.simulation_visible === true;
                const showSimControls = simEnabled && simVisible;

                const simCard = document.getElementById('simulatorCard');
                const simModeStatus = document.getElementById('simModeStatus');
                const btnToggleSim = document.getElementById('btnToggleSim');

                if (simCard) simCard.style.display = showSimControls ? 'block' : 'none';
                if (simModeStatus) simModeStatus.style.display = showSimControls ? 'flex' : 'none';
                if (btnToggleSim) btnToggleSim.style.display = showSimControls ? 'inline-block' : 'none';

                // Update serial UI to reflect current settings
                updateSerialUI();
            } catch (e) {
                console.error('Failed to get system status:', e);
            }
        }

        async function systemUpdate() {
            const statusDiv = document.getElementById('systemUpdateStatus');
            statusDiv.textContent = 'Updating from GitHub...';
            statusDiv.style.color = 'var(--primary)';
            try {
                const result = await api('/system/update', 'POST');
                if (result.status === 'ok') {
                    statusDiv.textContent = result.message || 'Update complete!';
                    statusDiv.style.color = 'var(--success)';
                } else {
                    statusDiv.textContent = 'Update failed: ' + (result.error || 'Unknown error');
                    statusDiv.style.color = 'var(--danger)';
                }
            } catch (e) {
                statusDiv.textContent = 'Update failed: ' + e.message;
                statusDiv.style.color = 'var(--danger)';
            }
        }

        async function refreshErrorLog() {
            try {
                const result = await api('/system/errors?lines=100');
                const content = document.getElementById('errorLogContent');
                if (result.errors && result.errors.length > 0) {
                    content.innerHTML = result.errors.map(e => `<div style="margin-bottom: 4px; border-bottom: 1px solid rgba(255,0,0,0.2); padding-bottom: 4px;">${escapeHtml(e)}</div>`).join('');
                } else {
                    content.textContent = 'No errors logged.';
                }
            } catch (e) {
                console.error('Failed to get error log:', e);
            }
        }

        async function clearErrorLog() {
            if (!confirm('Clear the error log?')) return;
            try {
                await api('/system/errors/clear', 'POST');
                refreshErrorLog();
            } catch (e) {
                alert('Failed to clear error log');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initialize system status
        refreshSystemStatus();
        setInterval(refreshSystemStatus, 30000);

        // Team Customization
        let teamConfig = {
            home: { name: 'HOME', short_name: 'HOM', logo: 'home.png', primary_color: '#1b6eb8', secondary_color: '#00529c' },
            away: { name: 'AWAY', short_name: 'AWY', logo: 'away.png', primary_color: '#aa0000', secondary_color: '#780000' }
        };

        async function refreshTeamConfig() {
            try {
                const teams = await api('/teams');
                teamConfig = teams;
                document.getElementById('homeTeamName').value = teams.home.name || '';
                document.getElementById('homeTeamShort').value = teams.home.short_name || '';
                document.getElementById('homeTeamColor').value = teams.home.primary_color || '#1b6eb8';
                document.getElementById('homeTeamColor2').value = teams.home.secondary_color || '#00529c';
                document.getElementById('awayTeamNameInput').value = teams.away.name || '';
                document.getElementById('awayTeamShort').value = teams.away.short_name || '';
                document.getElementById('awayTeamColor').value = teams.away.primary_color || '#aa0000';
                document.getElementById('awayTeamColor2').value = teams.away.secondary_color || '#780000';
                await refreshLogoOptions();
                document.getElementById('homeTeamLogo').value = teams.home.logo || 'home.png';
                document.getElementById('awayTeamLogo').value = teams.away.logo || 'away.png';
            } catch (e) {
                console.error('Failed to load team config:', e);
            }
        }

        async function refreshLogoOptions() {
            try {
                const result = await api('/teams/logos');
                const logos = result.logos || [];
                const homeSelect = document.getElementById('homeTeamLogo');
                const awaySelect = document.getElementById('awayTeamLogo');
                homeSelect.innerHTML = '';
                awaySelect.innerHTML = '';
                for (const logo of logos) {
                    homeSelect.innerHTML += `<option value="${logo}">${logo}</option>`;
                    awaySelect.innerHTML += `<option value="${logo}">${logo}</option>`;
                }
                if (logos.length === 0) {
                    homeSelect.innerHTML = '<option value="home.png">home.png</option>';
                    awaySelect.innerHTML = '<option value="away.png">away.png</option>';
                }
            } catch (e) {
                console.error('Failed to load logos:', e);
            }
        }

        async function applyTeamConfig() {
            const config = {
                home: {
                    name: document.getElementById('homeTeamName').value || 'HOME',
                    short_name: document.getElementById('homeTeamShort').value || 'HOM',
                    logo: document.getElementById('homeTeamLogo').value || 'home.png',
                    color: document.getElementById('homeTeamColor').value,
                    primary_color: document.getElementById('homeTeamColor').value,
                    secondary_color: document.getElementById('homeTeamColor2').value
                },
                away: {
                    name: document.getElementById('awayTeamNameInput').value || 'AWAY',
                    short_name: document.getElementById('awayTeamShort').value || 'AWY',
                    logo: document.getElementById('awayTeamLogo').value || 'away.png',
                    color: document.getElementById('awayTeamColor').value,
                    primary_color: document.getElementById('awayTeamColor').value,
                    secondary_color: document.getElementById('awayTeamColor2').value
                }
            };
            try {
                await api('/teams', 'POST', config);
                document.getElementById('teamConfigStatus').textContent = 'Applied!';
                document.getElementById('teamConfigStatus').style.color = 'var(--success)';
                setTimeout(() => { document.getElementById('teamConfigStatus').textContent = ''; }, 3000);
            } catch (e) {
                document.getElementById('teamConfigStatus').textContent = 'Failed';
                document.getElementById('teamConfigStatus').style.color = 'var(--danger)';
            }
        }

        function resetTeamConfig() {
            document.getElementById('homeTeamName').value = 'HOME';
            document.getElementById('homeTeamShort').value = 'HOM';
            document.getElementById('homeTeamColor').value = '#1b6eb8';
            document.getElementById('homeTeamColor2').value = '#00529c';
            document.getElementById('awayTeamNameInput').value = 'AWAY';
            document.getElementById('awayTeamShort').value = 'AWY';
            document.getElementById('awayTeamColor').value = '#aa0000';
            document.getElementById('awayTeamColor2').value = '#780000';
        }

        async function uploadLogo() {
            const fileInput = document.getElementById('logoUpload');
            const statusDiv = document.getElementById('uploadStatus');
            if (!fileInput.files || fileInput.files.length === 0) {
                statusDiv.textContent = 'Select a file first';
                statusDiv.style.color = 'var(--danger)';
                return;
            }
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            statusDiv.textContent = 'Uploading...';
            try {
                const response = await fetch('/api/teams/logo/upload', { method: 'POST', body: formData });
                const result = await response.json();
                if (result.status === 'ok') {
                    statusDiv.textContent = `Uploaded: ${result.filename}`;
                    statusDiv.style.color = 'var(--success)';
                    fileInput.value = '';
                    await refreshLogoOptions();
                } else {
                    statusDiv.textContent = `Error: ${result.error}`;
                    statusDiv.style.color = 'var(--danger)';
                }
            } catch (e) {
                statusDiv.textContent = 'Upload failed';
                statusDiv.style.color = 'var(--danger)';
            }
        }

        refreshTeamConfig();

        // Broadcast Overlay Controls
        async function triggerGoalSplash(team) { await api('/overlay/goal', 'POST', { team, duration: 5000 }); }
        async function hideOverlay(overlay) { await api(`/overlay/${overlay}/hide`, 'POST'); }
        async function showReplay() { await api('/overlay/replay', 'POST', { duration: 5000 }); }

        async function showPlayerCard(team) {
            const num = document.getElementById('playerNum').value || '00';
            const name = document.getElementById('playerName').value || 'PLAYER';
            const player = rosters[team]?.players?.find(p => p.number === num);
            await api('/overlay/player', 'POST', {
                team, number: num, name: player ? player.name : name,
                position: player?.position || 'F', goals: player?.goals || 0, assists: player?.assists || 0, duration: 5000
            });
        }

        async function showGoalieStats() {
            await api('/overlay/goalie', 'POST', {
                number: document.getElementById('goalieNum').value || '00',
                saves: parseInt(document.getElementById('goalieSaves').value) || 0,
                shots: parseInt(document.getElementById('goalieShots').value) || 0,
                duration: 6000
            });
        }

        async function showPeriodSummary() { await api('/overlay/period', 'POST', { duration: 8000 }); }
        async function showGameIntro() { await api('/overlay/intro', 'POST', { homeTeam: teamConfig.home?.name || 'HOME', awayTeam: teamConfig.away?.name || 'AWAY', duration: 8000 }); }
        async function showThreeStars() { await api('/overlay/stars', 'POST', { star1: { number: '87', name: '1ST STAR' }, star2: { number: '71', name: '2ND STAR' }, star3: { number: '30', name: '3RD STAR' }, duration: 10000 }); }
        async function showPowerPlay(team) { await api('/overlay/powerplay', 'POST', { team, duration: 120 }); }
        async function updateShotCounter() { await api('/overlay/shots', 'POST', { home: parseInt(document.getElementById('homeShots').value) || 0, away: parseInt(document.getElementById('awayShots').value) || 0 }); }
        async function addPenaltyOverlay(team) { await api('/overlay/penalty/add', 'POST', { team, number: '00', type: '2 MIN - MINOR', duration: 120 }); }
        async function showTicker() { await api('/overlay/ticker', 'POST', { scores: [{ away: 'NYR', awayScore: 3, home: 'BOS', homeScore: 2, status: 'FINAL' }] }); }

        // Roster Management
        let rosters = { home: { players: [] }, away: { players: [] } };

        async function refreshRosters() {
            try {
                rosters = await api('/roster');
                renderRoster('home');
                renderRoster('away');
            } catch (e) {
                console.error('Failed to load rosters:', e);
            }
        }

        function renderRoster(team) {
            const list = document.getElementById(team + 'RosterList');
            const players = rosters[team]?.players || [];
            const color = team === 'home' ? 'var(--home)' : 'var(--away)';

            if (players.length === 0) {
                list.innerHTML = '<div style="color: var(--text-dim); text-align: center; padding: 20px;">No players</div>';
                return;
            }

            list.innerHTML = players.map(p => `
                <div class="player-row">
                    <span class="player-number" style="color: ${color};">#${p.number}</span>
                    <span class="player-name">${p.name}</span>
                    <span class="player-pos">${p.position}</span>
                    <div class="player-stats">
                        <span class="goals">${p.goals || 0}G</span>
                        <span class="assists">${p.assists || 0}A</span>
                    </div>
                    <button class="btn btn-sm btn-primary" onclick="showPlayerFromRoster('${team}', '${p.number}')" style="padding: 4px 8px;">Show</button>
                    <button class="btn btn-sm btn-success" onclick="addGoalToPlayer('${team}', '${p.number}')" style="padding: 4px 8px;">+G</button>
                    <button class="btn btn-sm btn-warning" onclick="addAssistToPlayer('${team}', '${p.number}')" style="padding: 4px 8px;">+A</button>
                    <button class="btn btn-sm btn-danger" onclick="removeRosterPlayer('${team}', '${p.number}')" style="padding: 4px 8px;">X</button>
                </div>
            `).join('');
        }

        async function addRosterPlayer(team) {
            const num = document.getElementById(team + 'PlayerNum').value.trim();
            const name = document.getElementById(team + 'PlayerName').value.trim();
            const pos = document.getElementById(team + 'PlayerPos').value;
            if (!num) { alert('Number required'); return; }
            try {
                await api(`/roster/${team}/player`, 'POST', { number: num, name: name || 'PLAYER', position: pos });
                document.getElementById(team + 'PlayerNum').value = '';
                document.getElementById(team + 'PlayerName').value = '';
                await refreshRosters();
            } catch (e) { alert('Failed to add player'); }
        }

        async function removeRosterPlayer(team, number) {
            if (!confirm(`Remove #${number}?`)) return;
            try {
                await api(`/roster/${team}/player/${number}`, 'DELETE');
                await refreshRosters();
            } catch (e) { alert('Failed to remove player'); }
        }

        async function showPlayerFromRoster(team, number) {
            const player = rosters[team]?.players?.find(p => p.number === number);
            if (!player) return;
            await api('/overlay/player', 'POST', { team, number: player.number, name: player.name, position: player.position, goals: player.goals || 0, assists: player.assists || 0, duration: 5000 });
        }

        async function addGoalToPlayer(team, number) {
            try {
                await api(`/roster/${team}/player/${number}/stats`, 'POST', { add_goal: true });
                await refreshRosters();
            } catch (e) { alert('Failed'); }
        }

        async function addAssistToPlayer(team, number) {
            try {
                await api(`/roster/${team}/player/${number}/stats`, 'POST', { add_assist: true });
                await refreshRosters();
            } catch (e) { alert('Failed'); }
        }

        async function resetRosterStats() {
            if (!confirm('Reset all stats?')) return;
            try {
                await api('/roster/reset', 'POST');
                await refreshRosters();
            } catch (e) { alert('Failed'); }
        }

        socket.on('roster_update', (data) => {
            if (data.home) rosters.home = data.home;
            if (data.away) rosters.away = data.away;
            if (data.home) renderRoster('home');
            if (data.away) renderRoster('away');
        });

        refreshRosters();

        // Game History & Statistics
        let currentGameId = null;

        async function refreshGameHistory() {
            await Promise.all([loadCurrentGame(), loadRecentGames(), loadStatLeaders('points')]);
        }

        async function loadCurrentGame() {
            try {
                const result = await api('/games/current');
                const container = document.getElementById('currentGameInfo');
                if (result.game) {
                    currentGameId = result.game.id;
                    container.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--home); font-weight: 700;">${result.game.home_team}</span>
                            <span style="font-size: 1.5rem; font-weight: 800;">${result.game.home_score} - ${result.game.away_score}</span>
                            <span style="color: var(--away); font-weight: 700;">${result.game.away_team}</span>
                        </div>
                        <div style="text-align: center; margin-top: 8px; color: var(--text-dim); font-size: 0.8rem;">
                            Game #${result.game.id} | ${formatDateTime(result.game.started_at)}
                        </div>
                    `;
                } else {
                    currentGameId = null;
                    container.innerHTML = '<p style="color: var(--text-dim); text-align: center;">No active game</p>';
                }
            } catch (e) { console.error('Failed to load current game:', e); }
        }

        async function loadRecentGames() {
            try {
                const result = await api('/games?limit=10');
                const container = document.getElementById('recentGames');
                if (result.games && result.games.length > 0) {
                    container.innerHTML = result.games.map(game => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-input); border-radius: 8px; ${game.status === 'in_progress' ? 'border-left: 3px solid var(--primary);' : ''}">
                            <div>
                                <span style="color: var(--home);">${game.home_team}</span>
                                <span style="font-weight: 700; margin: 0 10px;">${game.home_score} - ${game.away_score}</span>
                                <span style="color: var(--away);">${game.away_team}</span>
                            </div>
                            <div style="color: var(--text-dim); font-size: 0.75rem; text-align: right;">
                                ${formatDateTime(game.started_at)}<br>
                                <span style="color: ${game.status === 'final' ? 'var(--success)' : 'var(--primary)'};">${game.status.toUpperCase()}</span>
                            </div>
                            <button class="btn btn-sm btn-secondary" style="margin-left: 10px;" onclick="viewGameSummary(${game.id})">View</button>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p style="color: var(--text-dim); text-align: center;">No games recorded</p>';
                }
            } catch (e) { console.error('Failed to load games:', e); }
        }

        async function loadStatLeaders(stat = 'points') {
            try {
                const result = await api(`/stats/leaders?stat=${stat}&limit=5`);
                const container = document.getElementById('statLeaders');
                if (result.leaders && result.leaders.length > 0) {
                    container.innerHTML = `<table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
                        <thead><tr style="color: var(--text-dim); font-size: 0.75rem;"><th style="text-align: left; padding: 6px;">#</th><th style="text-align: left;">Player</th><th style="text-align: center;">G</th><th style="text-align: center;">A</th><th style="text-align: center; color: var(--primary);">Pts</th></tr></thead>
                        <tbody>${result.leaders.map((p, i) => `<tr><td style="padding: 6px; color: var(--text-dim);">${i + 1}</td><td>#${p.player_number} ${p.player_name}</td><td style="text-align: center;">${p.goals}</td><td style="text-align: center;">${p.assists}</td><td style="text-align: center; font-weight: 700; color: var(--primary);">${p.points}</td></tr>`).join('')}</tbody>
                    </table>`;
                } else {
                    container.innerHTML = '<p style="color: var(--text-dim); text-align: center;">No stats yet</p>';
                }
            } catch (e) { console.error('Failed to load leaders:', e); }
        }

        async function startNewGame() {
            try {
                const result = await api('/games', 'POST', { home_team: 'HOME', away_team: 'AWAY' });
                if (result.game_id) { currentGameId = result.game_id; await refreshGameHistory(); alert(`Game #${result.game_id} started!`); }
            } catch (e) { alert('Failed: ' + e.message); }
        }

        async function endCurrentGame(status = 'final') {
            if (!currentGameId) { alert('No active game'); return; }
            if (!confirm(`${status === 'final' ? 'End' : 'Cancel'} this game?`)) return;
            try {
                await api(`/games/${currentGameId}/end`, 'POST', { status });
                await refreshGameHistory();
            } catch (e) { alert('Failed: ' + e.message); }
        }

        async function viewGameSummary(gameId) {
            try {
                const result = await api(`/games/${gameId}/summary`);
                if (result.game) {
                    const g = result.game;
                    alert(`Game #${g.id}\n${g.home_team} ${g.home_score} - ${g.away_score} ${g.away_team}\nStatus: ${g.status.toUpperCase()}\nShots: ${g.home_shots} - ${g.away_shots}`);
                }
            } catch (e) { alert('Failed: ' + e.message); }
        }

        function formatDateTime(isoString) {
            if (!isoString) return 'N/A';
            const d = new Date(isoString);
            return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        refreshGameHistory();
    </script>
</body>
</html>
