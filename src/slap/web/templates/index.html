<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLAP - Scoreboard Live Automation Platform</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            color: #00d4ff;
            margin-bottom: 5px;
        }

        .header .subtitle {
            color: #888;
            font-size: 0.9rem;
        }

        /* Mode Toggle */
        .mode-toggle {
            display: flex;
            justify-content: center;
            gap: 0;
            margin-top: 15px;
        }

        .mode-btn {
            padding: 10px 30px;
            border: 2px solid #00d4ff;
            background: transparent;
            color: #00d4ff;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-btn:first-child {
            border-radius: 8px 0 0 8px;
        }

        .mode-btn:last-child {
            border-radius: 0 8px 8px 0;
            border-left: none;
        }

        .mode-btn.active {
            background: #00d4ff;
            color: #000;
        }

        .mode-btn.preview.active {
            background: #00d4ff;
            border-color: #00d4ff;
        }

        .mode-btn.live.active {
            background: #ff4444;
            border-color: #ff4444;
            color: #fff;
        }

        .mode-btn.live {
            border-color: #ff4444;
            color: #ff4444;
        }

        .mode-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .mode-indicator.preview {
            background: #00d4ff;
            color: #000;
        }

        .mode-indicator.live {
            background: #ff4444;
            color: #fff;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 1000px) {
            .container {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: #16213e;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #0f3460;
        }

        .card h2 {
            color: #00d4ff;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2::before {
            content: '';
            width: 4px;
            height: 20px;
            background: #00d4ff;
            border-radius: 2px;
        }

        /* Scorebug Preview */
        .preview-container {
            grid-column: 1 / -1;
        }

        .preview-frame {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .preview-frame iframe {
            width: 100%;
            height: 100%;
            border: none;
            transform-origin: top left;
        }

        /* Score Display */
        .score-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            padding: 20px;
        }

        .team {
            text-align: center;
        }

        .team-name {
            font-size: 1.2rem;
            color: #888;
            margin-bottom: 10px;
        }

        .team-score {
            font-size: 4rem;
            font-weight: bold;
        }

        .team-score.home { color: #4a9eff; }
        .team-score.away { color: #ff4a4a; }

        .vs {
            font-size: 1.5rem;
            color: #444;
        }

        /* Game Info */
        .game-info {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 15px;
        }

        .info-item {
            text-align: center;
        }

        .info-label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #fff;
        }

        /* Controls */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: #00d4ff;
            color: #000;
        }

        .btn-primary:hover {
            background: #00b8e6;
        }

        .btn-success {
            background: #00c853;
            color: #000;
        }

        .btn-danger {
            background: #ff1744;
            color: #fff;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .btn-secondary {
            background: #444;
            color: #fff;
        }

        .btn-home {
            background: #4a9eff;
            color: #000;
        }

        .btn-away {
            background: #ff4a4a;
            color: #fff;
        }

        .btn-group {
            display: flex;
            gap: 5px;
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 0.8rem;
        }

        /* Status indicators */
        .status-bar {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ff1744;
        }

        .status-dot.connected {
            background: #00c853;
        }

        .status-label {
            font-size: 0.9rem;
            color: #888;
        }

        /* Penalties */
        .penalties {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .penalty-box {
            background: #0f3460;
            padding: 15px 20px;
            border-radius: 8px;
            min-width: 150px;
        }

        .penalty-box h3 {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 10px;
        }

        .penalty-list {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .penalty-list.home { color: #4a9eff; }
        .penalty-list.away { color: #ff4a4a; }

        /* Manual Input */
        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .input-group label {
            min-width: 80px;
            color: #888;
        }

        .input-group input {
            background: #0f3460;
            border: 1px solid #1a4a7a;
            border-radius: 6px;
            padding: 8px 12px;
            color: #fff;
            font-size: 1rem;
            width: 100px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #00d4ff;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>SLAP <span class="mode-indicator preview" id="modeIndicator">PREVIEW</span></h1>
        <p class="subtitle">Scoreboard Live Automation Platform</p>
        <div class="mode-toggle">
            <button class="mode-btn preview active" id="btnPreview" onclick="setMode('preview')">Preview</button>
            <button class="mode-btn live" id="btnLive" onclick="setMode('live')">Live</button>
        </div>
    </div>

    <div class="container">
        <!-- Scorebug Preview -->
        <div class="card preview-container">
            <h2 id="previewTitle">Preview</h2>
            <div class="preview-frame">
                <iframe id="scorebugPreview" src="/scorebug"></iframe>
            </div>
        </div>

        <!-- Score Display -->
        <div class="card">
            <h2>Current Score</h2>
            <div class="score-display">
                <div class="team">
                    <div class="team-name" id="homeTeamName">HOME</div>
                    <div class="team-score home" id="homeScore">0</div>
                </div>
                <div class="vs">vs</div>
                <div class="team">
                    <div class="team-name" id="awayTeamName">AWAY</div>
                    <div class="team-score away" id="awayScore">0</div>
                </div>
            </div>
            <div class="game-info">
                <div class="info-item">
                    <div class="info-label">Period</div>
                    <div class="info-value" id="period">1st</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Clock</div>
                    <div class="info-value" id="clock">20:00</div>
                </div>
            </div>
        </div>

        <!-- Simulator Controls -->
        <div class="card">
            <h2>Simulator</h2>
            <div class="controls">
                <button class="btn btn-success" onclick="startSimulator()">Start</button>
                <button class="btn btn-danger" onclick="stopSimulator()">Stop</button>
                <button class="btn btn-warning" onclick="resetSimulator()">Reset</button>
            </div>
            <div class="status-bar" style="margin-top: 15px;">
                <div class="status-item">
                    <div class="status-dot" id="simStatus"></div>
                    <span class="status-label">Simulator</span>
                </div>
            </div>
        </div>

        <!-- Goal Controls -->
        <div class="card">
            <h2>Goals</h2>
            <div class="controls">
                <button class="btn btn-home" onclick="triggerGoal('HOME')">Home Goal</button>
                <button class="btn btn-away" onclick="triggerGoal('AWAY')">Away Goal</button>
            </div>
        </div>

        <!-- Score Adjustments -->
        <div class="card">
            <h2>Manual Score</h2>
            <div class="controls">
                <div class="btn-group">
                    <button class="btn btn-sm btn-home" onclick="adjustScore('home', -1)">-</button>
                    <span style="padding: 8px; color: #4a9eff;">Home</span>
                    <button class="btn btn-sm btn-home" onclick="adjustScore('home', 1)">+</button>
                </div>
                <div class="btn-group">
                    <button class="btn btn-sm btn-away" onclick="adjustScore('away', -1)">-</button>
                    <span style="padding: 8px; color: #ff4a4a;">Away</span>
                    <button class="btn btn-sm btn-away" onclick="adjustScore('away', 1)">+</button>
                </div>
            </div>
        </div>

        <!-- Period/Clock Controls -->
        <div class="card">
            <h2>Clock Controls</h2>
            <div class="input-group">
                <label>Period:</label>
                <select id="periodSelect" onchange="updatePeriod()" style="background: #0f3460; border: 1px solid #1a4a7a; border-radius: 6px; padding: 8px 12px; color: #fff;">
                    <option value="1">1st</option>
                    <option value="2">2nd</option>
                    <option value="3">3rd</option>
                    <option value="OT">OT</option>
                </select>
            </div>
            <div class="input-group">
                <label>Clock:</label>
                <input type="text" id="clockInput" value="20:00" placeholder="MM:SS">
                <button class="btn btn-sm btn-primary" onclick="updateClock()">Set</button>
            </div>
        </div>

        <!-- Penalties -->
        <div class="card">
            <h2>Penalties</h2>
            <div class="penalties">
                <div class="penalty-box">
                    <h3>Home</h3>
                    <div class="penalty-list home" id="homePenalties">None</div>
                </div>
                <div class="penalty-box">
                    <h3>Away</h3>
                    <div class="penalty-list away" id="awayPenalties">None</div>
                </div>
            </div>
            <div class="controls" style="margin-top: 15px; justify-content: center;">
                <button class="btn btn-sm btn-home" onclick="addPenalty('HOME', 120)">Home 2min</button>
                <button class="btn btn-sm btn-home" onclick="addPenalty('HOME', 300)">Home 5min</button>
                <button class="btn btn-sm btn-away" onclick="addPenalty('AWAY', 120)">Away 2min</button>
                <button class="btn btn-sm btn-away" onclick="addPenalty('AWAY', 300)">Away 5min</button>
            </div>
        </div>

        <!-- Bug Visibility -->
        <div class="card">
            <h2>Scorebug Display</h2>
            <div class="controls">
                <button class="btn btn-success" onclick="showBug()">Show</button>
                <button class="btn btn-danger" onclick="hideBug()">Hide</button>
            </div>
            <div class="status-bar" style="margin-top: 15px;">
                <div class="status-item">
                    <div class="status-dot" id="bugStatus"></div>
                    <span class="status-label">Visible</span>
                </div>
            </div>
        </div>

        <!-- Connection Status -->
        <div class="card">
            <h2>Connection Status</h2>
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-dot" id="serialStatus"></div>
                    <span class="status-label">Serial</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="casparStatus"></div>
                    <span class="status-label">CasparCG</span>
                </div>
                <div class="status-item">
                    <div class="status-dot connected" id="wsStatus"></div>
                    <span class="status-label">WebSocket</span>
                </div>
            </div>
        </div>

        <!-- CasparCG Server Control -->
        <div class="card">
            <h2>CasparCG Server</h2>
            <div class="status-bar" style="margin-bottom: 15px;">
                <div class="status-item">
                    <div class="status-dot" id="casparInstalled"></div>
                    <span class="status-label">Installed</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="casparRunning"></div>
                    <span class="status-label">Running</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="casparAmcp"></div>
                    <span class="status-label">AMCP</span>
                </div>
            </div>
            <div class="controls">
                <button class="btn btn-success" onclick="casparStart()" id="btnCasparStart">Start Server</button>
                <button class="btn btn-danger" onclick="casparStop()" id="btnCasparStop">Stop Server</button>
                <button class="btn btn-primary" onclick="casparConnect()" id="btnCasparConnect">Connect</button>
                <button class="btn btn-secondary" onclick="casparRefresh()">Refresh</button>
            </div>
            <div id="casparInfo" style="margin-top: 10px; font-size: 0.85rem; color: #888;"></div>
        </div>

        <!-- OBS Studio Control -->
        <div class="card">
            <h2>OBS Studio</h2>
            <div class="status-bar" style="margin-bottom: 15px;">
                <div class="status-item">
                    <div class="status-dot" id="obsInstalled"></div>
                    <span class="status-label">Installed</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="obsRunning"></div>
                    <span class="status-label">Running</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="obsWebsocket"></div>
                    <span class="status-label">WebSocket</span>
                </div>
                <div class="status-item">
                    <div class="status-dot" id="obsConnected"></div>
                    <span class="status-label">Connected</span>
                </div>
            </div>
            <div class="controls">
                <button class="btn btn-success" onclick="obsStart()" id="btnObsStart">Start OBS</button>
                <button class="btn btn-danger" onclick="obsStop()" id="btnObsStop">Stop OBS</button>
                <button class="btn btn-primary" onclick="obsConnect()" id="btnObsConnect">Connect</button>
                <button class="btn btn-secondary" onclick="obsRefresh()">Refresh</button>
            </div>
            <div id="obsInfo" style="margin-top: 10px; font-size: 0.85rem; color: #888;"></div>
        </div>

        <!-- OBS Scorebug Setup -->
        <div class="card" id="obsScorebuCard" style="display: none;">
            <h2>OBS Scorebug Overlay</h2>
            <p style="color: #888; font-size: 0.9rem; margin-bottom: 15px;">
                Add the SLAP scorebug as a browser source in your current OBS scene.
            </p>
            <div class="controls">
                <button class="btn btn-primary" onclick="obsSetupScoreBug()">Add Scorebug to Scene</button>
                <button class="btn btn-success" onclick="obsShowScoreBug()">Show</button>
                <button class="btn btn-danger" onclick="obsHideScoreBug()">Hide</button>
                <button class="btn btn-secondary" onclick="obsRefreshScoreBug()">Refresh</button>
            </div>
            <div id="obsSceneInfo" style="margin-top: 10px; font-size: 0.85rem; color: #888;"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        // WebSocket connection
        const socket = io();

        // State
        let currentState = {
            game: { home: 0, away: 0, period: "1", clock: "20:00", home_penalties: [], away_penalties: [] },
            bug_visible: true,
            simulator_running: false,
            serial_connected: false,
            caspar_connected: false
        };

        // Socket events
        socket.on('connect', () => {
            console.log('Connected to SLAP server');
            document.getElementById('wsStatus').classList.add('connected');
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from SLAP server');
            document.getElementById('wsStatus').classList.remove('connected');
        });

        socket.on('state_update', (state) => {
            currentState = state;
            updateUI();
        });

        // Update UI from state
        function updateUI() {
            const game = currentState.game;

            // Scores
            document.getElementById('homeScore').textContent = game.home;
            document.getElementById('awayScore').textContent = game.away;

            // Period
            let periodText = game.period;
            if (periodText === "1") periodText = "1st";
            else if (periodText === "2") periodText = "2nd";
            else if (periodText === "3") periodText = "3rd";
            document.getElementById('period').textContent = periodText;
            document.getElementById('periodSelect').value = game.period;

            // Clock
            document.getElementById('clock').textContent = game.clock;
            document.getElementById('clockInput').value = game.clock;

            // Penalties
            const homePens = game.home_penalties || [];
            const awayPens = game.away_penalties || [];
            document.getElementById('homePenalties').textContent =
                homePens.length ? homePens.map(formatPenalty).join(', ') : 'None';
            document.getElementById('awayPenalties').textContent =
                awayPens.length ? awayPens.map(formatPenalty).join(', ') : 'None';

            // Status indicators
            updateStatus('simStatus', currentState.simulator_running);
            updateStatus('bugStatus', currentState.bug_visible);
            updateStatus('serialStatus', currentState.serial_connected);
            updateStatus('casparStatus', currentState.caspar_connected);

            // Update scorebug preview
            updateScorebugPreview();
        }

        function formatPenalty(seconds) {
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            return `${m}:${s.toString().padStart(2, '0')}`;
        }

        function updateStatus(id, connected) {
            const el = document.getElementById(id);
            if (connected) {
                el.classList.add('connected');
            } else {
                el.classList.remove('connected');
            }
        }

        function updateScorebugPreview() {
            const iframe = document.getElementById('scorebugPreview');
            if (iframe.contentWindow && iframe.contentWindow.updateFromParent) {
                iframe.contentWindow.updateFromParent(currentState.game);
            }
        }

        // API calls
        async function api(endpoint, method = 'GET', data = null) {
            const options = { method, headers: { 'Content-Type': 'application/json' } };
            if (data) options.body = JSON.stringify(data);
            const response = await fetch(`/api${endpoint}`, options);
            return response.json();
        }

        // Control functions
        function startSimulator() { api('/simulator/start', 'POST'); }
        function stopSimulator() { api('/simulator/stop', 'POST'); }
        function resetSimulator() { api('/simulator/reset', 'POST'); }

        function triggerGoal(side) { api('/goal', 'POST', { side }); }

        function adjustScore(team, delta) {
            const newScore = Math.max(0, currentState.game[team === 'home' ? 'home' : 'away'] + delta);
            const data = team === 'home' ? { home: newScore } : { away: newScore };
            api('/state', 'POST', data);
        }

        function updatePeriod() {
            const period = document.getElementById('periodSelect').value;
            api('/state', 'POST', { period });
        }

        function updateClock() {
            const clock = document.getElementById('clockInput').value;
            api('/state', 'POST', { clock });
        }

        function addPenalty(side, duration) {
            api('/penalty', 'POST', { side, duration });
        }

        function showBug() { api('/bug/show', 'POST'); }
        function hideBug() { api('/bug/hide', 'POST'); }

        // Mode switching
        let currentMode = 'preview';

        async function setMode(mode) {
            const result = await api('/mode', 'POST', { mode });
            if (result.status === 'ok') {
                currentMode = result.mode;
                updateModeUI();
            }
        }

        function updateModeUI() {
            const indicator = document.getElementById('modeIndicator');
            const btnPreview = document.getElementById('btnPreview');
            const btnLive = document.getElementById('btnLive');
            const title = document.getElementById('previewTitle');

            // Update indicator
            indicator.className = 'mode-indicator ' + currentMode;
            indicator.textContent = currentMode.toUpperCase();

            // Update buttons
            btnPreview.classList.toggle('active', currentMode === 'preview');
            btnLive.classList.toggle('active', currentMode === 'live');

            // Update title
            title.textContent = currentMode === 'preview' ? 'Preview' : 'Live Output';
        }

        // Listen for mode changes from server
        socket.on('mode_change', (data) => {
            currentMode = data.mode;
            updateModeUI();
        });

        // Initial state fetch
        api('/state').then(state => {
            currentState = state;
            updateUI();
        });

        // Get initial mode
        api('/mode').then(data => {
            currentMode = data.mode;
            updateModeUI();
        });

        // CasparCG Server Control
        let casparState = {
            installed: false,
            running: false,
            amcp_listening: false,
            connected: false,
            binary: null
        };

        async function casparRefresh() {
            try {
                const status = await api('/caspar/status');
                casparState = status;
                updateCasparUI();
            } catch (e) {
                console.error('Failed to get CasparCG status:', e);
            }
        }

        function updateCasparUI() {
            updateStatus('casparInstalled', casparState.installed);
            updateStatus('casparRunning', casparState.running);
            updateStatus('casparAmcp', casparState.amcp_listening);

            const info = document.getElementById('casparInfo');
            if (casparState.installed) {
                let text = `Binary: ${casparState.binary || 'found'}`;
                if (casparState.running && casparState.pid) {
                    text += ` | PID: ${casparState.pid}`;
                }
                if (casparState.amcp_listening) {
                    text += ' | AMCP: port 5250';
                }
                info.textContent = text;
            } else {
                info.innerHTML = 'Not installed. Run: <code>./deploy.sh caspar-install</code>';
            }

            // Update button states
            document.getElementById('btnCasparStart').disabled = !casparState.installed || casparState.running;
            document.getElementById('btnCasparStop').disabled = !casparState.running;
            document.getElementById('btnCasparConnect').disabled = !casparState.amcp_listening;
        }

        async function casparStart() {
            document.getElementById('btnCasparStart').disabled = true;
            document.getElementById('btnCasparStart').textContent = 'Starting...';
            try {
                await api('/caspar/start', 'POST');
                // Wait for it to start
                setTimeout(casparRefresh, 3000);
            } catch (e) {
                alert('Failed to start CasparCG: ' + e.message);
            }
            document.getElementById('btnCasparStart').textContent = 'Start Server';
        }

        async function casparStop() {
            document.getElementById('btnCasparStop').disabled = true;
            try {
                await api('/caspar/stop', 'POST');
                setTimeout(casparRefresh, 1000);
            } catch (e) {
                alert('Failed to stop CasparCG: ' + e.message);
            }
        }

        async function casparConnect() {
            document.getElementById('btnCasparConnect').disabled = true;
            document.getElementById('btnCasparConnect').textContent = 'Connecting...';
            try {
                const result = await api('/caspar/connect', 'POST');
                if (result.connected) {
                    updateStatus('casparStatus', true);
                }
            } catch (e) {
                alert('Failed to connect to CasparCG');
            }
            document.getElementById('btnCasparConnect').textContent = 'Connect';
            casparRefresh();
        }

        // Initial CasparCG status check
        casparRefresh();
        // Refresh CasparCG status every 10 seconds
        setInterval(casparRefresh, 10000);

        // OBS Studio Control
        let obsState = {
            installed: false,
            running: false,
            websocket_listening: false,
            connected: false,
            binary: null,
            version: null,
            current_scene: null
        };

        async function obsRefresh() {
            try {
                const status = await api('/obs/status');
                obsState = status;
                updateObsUI();
            } catch (e) {
                console.error('Failed to get OBS status:', e);
            }
        }

        function updateObsUI() {
            updateStatus('obsInstalled', obsState.installed);
            updateStatus('obsRunning', obsState.running);
            updateStatus('obsWebsocket', obsState.websocket_listening);
            updateStatus('obsConnected', obsState.connected);

            const info = document.getElementById('obsInfo');
            const scorebugCard = document.getElementById('obsScorebuCard');
            const sceneInfo = document.getElementById('obsSceneInfo');

            if (obsState.installed) {
                let text = `Binary: ${obsState.binary || 'found'}`;
                if (obsState.running && obsState.pid) {
                    text += ` | PID: ${obsState.pid}`;
                }
                if (obsState.connected && obsState.current_scene) {
                    text += ` | Scene: ${obsState.current_scene}`;
                }
                info.textContent = text;

                // Show WebSocket setup instructions if not listening
                if (obsState.running && !obsState.websocket_listening) {
                    info.innerHTML = text + '<br><span style="color: #ffc107;">Enable WebSocket: Tools &gt; WebSocket Server Settings</span>';
                }
            } else {
                info.innerHTML = 'Not installed. Download from <a href="https://obsproject.com/" target="_blank" style="color: #00d4ff;">obsproject.com</a>';
            }

            // Show scorebug card if connected
            if (obsState.connected) {
                scorebugCard.style.display = 'block';
                sceneInfo.textContent = `Current scene: ${obsState.current_scene || 'unknown'}`;
            } else {
                scorebugCard.style.display = 'none';
            }

            // Update button states
            document.getElementById('btnObsStart').disabled = !obsState.installed || obsState.running;
            document.getElementById('btnObsStop').disabled = !obsState.running;
            document.getElementById('btnObsConnect').disabled = !obsState.websocket_listening || obsState.connected;
        }

        async function obsStart() {
            document.getElementById('btnObsStart').disabled = true;
            document.getElementById('btnObsStart').textContent = 'Starting...';
            try {
                await api('/obs/start', 'POST');
                setTimeout(obsRefresh, 3000);
            } catch (e) {
                alert('Failed to start OBS: ' + e.message);
            }
            document.getElementById('btnObsStart').textContent = 'Start OBS';
        }

        async function obsStop() {
            document.getElementById('btnObsStop').disabled = true;
            try {
                await api('/obs/stop', 'POST');
                setTimeout(obsRefresh, 1000);
            } catch (e) {
                alert('Failed to stop OBS: ' + e.message);
            }
        }

        async function obsConnect() {
            document.getElementById('btnObsConnect').disabled = true;
            document.getElementById('btnObsConnect').textContent = 'Connecting...';
            try {
                const result = await api('/obs/connect', 'POST');
                if (result.connected) {
                    obsState.connected = true;
                    obsState.current_scene = result.current_scene;
                    obsState.version = result.version;
                    updateObsUI();
                } else {
                    alert('Failed to connect: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Failed to connect to OBS WebSocket. Make sure it\'s enabled in OBS.');
            }
            document.getElementById('btnObsConnect').textContent = 'Connect';
            obsRefresh();
        }

        async function obsSetupScoreBug() {
            try {
                const result = await api('/obs/setup-scorebug', 'POST');
                if (result.status === 'ok') {
                    alert('Scorebug overlay added to scene: ' + result.source_name);
                    obsRefresh();
                } else {
                    alert('Failed to add scorebug: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Failed to add scorebug overlay');
            }
        }

        async function obsShowScoreBug() {
            try {
                await api('/obs/scorebug/show', 'POST');
            } catch (e) {
                alert('Failed to show scorebug');
            }
        }

        async function obsHideScoreBug() {
            try {
                await api('/obs/scorebug/hide', 'POST');
            } catch (e) {
                alert('Failed to hide scorebug');
            }
        }

        async function obsRefreshScoreBug() {
            try {
                await api('/obs/scorebug/refresh', 'POST');
            } catch (e) {
                alert('Failed to refresh scorebug');
            }
        }

        // Initial OBS status check
        obsRefresh();
        // Refresh OBS status every 10 seconds
        setInterval(obsRefresh, 10000);
    </script>
</body>
</html>
